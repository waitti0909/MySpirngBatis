<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foya.dao.mybatis.mapper.UTbPayPaymentRequestMapper">
	<resultMap id="ResultMap" type="com.foya.noms.dto.pay.TbPayPaymentRequestDTO">
	    <!--
	      WARNING - @mbggenerated
	      This element is automatically generated by MyBatis Generator, do not modify.
	      This element was generated on Tue Jan 27 18:23:50 CST 2015.
	    -->
	    <result column="sumAmt" jdbcType="DECIMAL" property="sumAmt" />
	    <result column="pldgAmt" jdbcType="DECIMAL" property="pldgAmt" />
	    <result column="rentAmt" jdbcType="DECIMAL" property="rentAmt" />
	    <result column="paymentReqBeginDate" jdbcType="VARCHAR" property="paymentReqBeginDate" />
	    <result column="paymentReqEndDate" jdbcType="VARCHAR" property="paymentReqEndDate" />
	    <result column="lsSdate" jdbcType="VARCHAR" property="lsSdate" />
	    <result column="statusDesc" jdbcType="VARCHAR" property="statusDesc" />
	    <result column="pay_begin_date" jdbcType="DATE" property="pay_begin_date" />
	    <result column="voucher_credit" jdbcType="VARCHAR" property="voucher_credit" />
	    <result column="processType" jdbcType="VARCHAR" property="processType" />
	    <result column="s_tax_exclusive_amt" jdbcType="DECIMAL" property="s_tax_exclusive_amt" />
	    <result column="s_amt" jdbcType="DECIMAL" property="s_amt" />
	    <result column="s_business_tax" jdbcType="DECIMAL" property="s_business_tax" />
    </resultMap>

	<select id="selectTbPayPaymentRequest" resultType="com.foya.noms.dto.pay.TbPayPaymentRequestDTO" parameterType="hashmap">
	Select
		(Select SUM(B.tax_exclusive_amt + B.business_tax) 
		from TB_PAY_PAYMENT_REQUEST_DTL B 
		Where B.payment_req_no =A.payment_req_no
		) sumAmt,
		A.contract_no,
		A.payment_months,
		A.payment_req_begin_date,
		A.payment_req_end_date,
		(select ls_name from TB_LS_MAIN where ls_no=A.contract_no and ls_status=1)lsName,
		(select sum(pldg_amt) from TB_LS_LOCATION where ls_no=A.contract_no and convert(date,#{appDate}) between eff_date and end_date ) pldgAmt,
		(select sum(rent_amt) from TB_LS_LOCATION where ls_no=A.contract_no and convert(date,#{appDate}) between eff_date and end_date ) rentAmt,
		(select ls_s_date from TB_LS_MAIN where ls_no=A.contract_no and ls_status=1) lsSdate,
		A.payment_req_no,
		#{processTypeDesc} statusDesc
	from TB_PAY_PAYMENT_REQUEST A 
	Where A.cash_req_no= #{cashReqNo}
		Group by A.contract_no,
		A.payment_months,
		A.payment_req_begin_date,
		A.payment_req_end_date,A.payment_req_no
	</select>
	
	<select id="searchForPay003DtlMaster" resultMap="ResultMap" parameterType="hashmap">
	<![CDATA[	
	Select 
	A.contract_no,
    (select ls_name from TB_LS_MAIN where ls_no=A.contract_no and ls_status=1) lsName,
	(select lookup_code_desc from TB_PAY_LOOKUP_CODE where lookup_type='process_type' and lookup_code=#{processType}) processType,
	(select sum(pldg_amt) from TB_LS_LOCATION where ls_no=A.contract_no and A.CR_TIME between eff_date and end_date) pldgAmt,
	(select sum(rent_amt) from TB_LS_LOCATION where ls_no=A.contract_no and A.CR_TIME between eff_date and end_date) rentAmt,
	A.payment_months,
	(select ls_s_date from TB_LS_MAIN where ls_no=A.contract_no and ls_status=1) pay_BEGIN_DATE,
	A.payment_req_begin_date, 
	A.payment_req_end_date,
    C.s_tax_exclusive_amt,
    C.s_business_tax,
    C.s_amt,
	A.cash_req_no,
	A.payment_req_no,
	voucher_credit  = CASE(select count(*) from TB_PAY_VOUCHER_CREDIT where payment_req_no in (select payment_req_no from TB_PAY_PAYMENT_REQUEST where contract_no=A.contract_no) )　
	when 0 then '否'
	else '是' end
	from TB_PAY_PAYMENT_REQUEST A , 
    (Select SUM(B.tax_exclusive_amt) s_tax_exclusive_amt, SUM(B. business_tax) s_business_tax ,SUM(B. tax_exclusive_amt+B. business_tax) s_amt,B. payment_req_no 
    from TB_PAY_PAYMENT_REQUEST_DTL B group by B.payment_req_no
    ) C
	]]>  
	Where  
	C.PAYMENT_REQ_NO = A.PAYMENT_REQ_NO
	AND A.cash_req_no= #{cashReqNo}

			
	</select>
	
		<insert id="insertSelective" parameterType="com.foya.dao.mybatis.model.TbPayPaymentRequest" useGeneratedKeys="true" keyProperty="PAYMENT_REQ_NO">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jan 29 17:24:41 CST 2015.
    -->
    insert into TB_PAY_PAYMENT_REQUEST
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="PAYMENT_REQ_NO != null" >
        PAYMENT_REQ_NO,
      </if>
      <if test="CASH_REQ_NO != null" >
        CASH_REQ_NO,
      </if>
      <if test="PAYMENT_REQ_BEGIN_DATE != null" >
        PAYMENT_REQ_BEGIN_DATE,
      </if>
      <if test="PAYMENT_REQ_END_DATE != null" >
        PAYMENT_REQ_END_DATE,
      </if>
      <if test="SUSPEND_DATE != null" >
        SUSPEND_DATE,
      </if>
      <if test="SUSPEND_REASON != null" >
        SUSPEND_REASON,
      </if>
      <if test="SUSPEND_MEMO != null" >
        SUSPEND_MEMO,
      </if>
      <if test="SUSPEND_USER != null" >
        SUSPEND_USER,
      </if>
      <if test="PAYMENT_MONTHS != null" >
        PAYMENT_MONTHS,
      </if>
      <if test="CR_USER != null" >
        CR_USER,
      </if>
      <if test="CR_TIME != null" >
        CR_TIME,
      </if>
      <if test="MD_USER != null" >
        MD_USER,
      </if>
      <if test="MD_TIME != null" >
        MD_TIME,
      </if>
      <if test="CONTRACT_NO != null" >
        CONTRACT_NO,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="PAYMENT_REQ_NO != null" >
        #{PAYMENT_REQ_NO,jdbcType=BIGINT},
      </if>
      <if test="CASH_REQ_NO != null" >
        #{CASH_REQ_NO,jdbcType=VARCHAR},
      </if>
      <if test="PAYMENT_REQ_BEGIN_DATE != null" >
        #{PAYMENT_REQ_BEGIN_DATE,jdbcType=TIMESTAMP},
      </if>
      <if test="PAYMENT_REQ_END_DATE != null" >
        #{PAYMENT_REQ_END_DATE,jdbcType=TIMESTAMP},
      </if>
      <if test="SUSPEND_DATE != null" >
        #{SUSPEND_DATE,jdbcType=TIMESTAMP},
      </if>
      <if test="SUSPEND_REASON != null" >
        #{SUSPEND_REASON,jdbcType=VARCHAR},
      </if>
      <if test="SUSPEND_MEMO != null" >
        #{SUSPEND_MEMO,jdbcType=VARCHAR},
      </if>
      <if test="SUSPEND_USER != null" >
        #{SUSPEND_USER,jdbcType=VARCHAR},
      </if>
      <if test="PAYMENT_MONTHS != null" >
        #{PAYMENT_MONTHS,jdbcType=TINYINT},
      </if>
      <if test="CR_USER != null" >
        #{CR_USER,jdbcType=VARCHAR},
      </if>
      <if test="CR_TIME != null" >
        #{CR_TIME,jdbcType=TIMESTAMP},
      </if>
      <if test="MD_USER != null" >
        #{MD_USER,jdbcType=VARCHAR},
      </if>
      <if test="MD_TIME != null" >
        #{MD_TIME,jdbcType=TIMESTAMP},
      </if>
      <if test="CONTRACT_NO != null" >
        #{CONTRACT_NO,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  
	<!--************************************************************************************************************-->
	<!--************************************************************************************************************-->
	<!--************************************************************************************************************-->
	
	<resultMap id="payPaymentResultMap" type="com.foya.noms.dto.pay.TbPayPaymentRequestCompleteDTO">
	 	<result column="PROCESS_TYPE" property="payBillsProcessType" />
    	<result column="LS_NAME" property="lsMainName" />
	    <result column="PLD_AMT" property="locationPldgAmtSum" />
	    <result column="RENT_AMT" property="locationRentAmtSum" />
	    <result column="LS_S_DATE" property="lsMainDate" />
	    <result column="S_AMT" property="payBillsTotal" />
	    <result column="APP_DATE" property="payBillsAppDate" />
    </resultMap>
    
    <!-- 取得請款資料 -->
	<select id="getPayRequirementData" resultMap="payPaymentResultMap">
		Select 
			payBills.APP_DATE,
			payBillsData.PAYMENT_REQ_NO,
			payBillsData.CASH_REQ_NO,
			payBills.PROCESS_TYPE,
			payBillsData.CONTRACT_NO,
			(Select LS_NAME From TB_LS_MAIN Where LS_NO = payBillsData.CONTRACT_NO) as LS_NAME,
			(Select SUM(PLDG_AMT) From TB_LS_LOCATION Where payBills.APP_DATE Between EFF_DATE And END_DATE And LS_NO = payBillsData.CONTRACT_NO) as PLD_AMT,
			(Select SUM(RENT_AMT) From TB_LS_LOCATION Where payBills.APP_DATE Between EFF_DATE And END_DATE And LS_NO = payBillsData.CONTRACT_NO) as RENT_AMT,
			payBillsData.PAYMENT_MONTHS,
			(Select LS_S_DATE From TB_LS_MAIN Where LS_NO = payBillsData.CONTRACT_NO And LS_STATUS = 1) as LS_S_DATE,
			payBillsData.PAYMENT_REQ_BEGIN_DATE,
			payBillsData.PAYMENT_REQ_END_DATE,
			(Select sum(TAX_EXCLUSIVE_AMT+BUSINESS_TAX) from TB_PAY_PAYMENT_REQUEST_DTL Where PAYMENT_REQ_NO = payBillsData.PAYMENT_REQ_NO) as S_AMT
		From 
			TB_PAY_PAYMENT_REQUEST as payBillsData
		JOIN 
			TB_PAY_CASH_REQUIREMENT as payBills
		ON	payBills.CASH_REQ_NO = payBillsData.CASH_REQ_NO
		<!-- JOIN
			TB_PAY_PAYMENT as payPayment
		ON	payPayment.PAYMENT_REQ_NO = payBillsData.PAYMENT_REQ_NO-->
		Where
			payBills.CASH_REQ_NO = #{cashReqNo}
		<if test="domain != null and domain != ''">
			And payBills.DOMAIN = #{domain}
		</if>
		<if test="applyType != null and applyType != ''">
			And payBills.STATUS = #{applyType}
		</if>
		<if test="payType != null and payType != ''">
			And payPayment.STATUS= #{payType}
		</if>
		And payBills.status='F'
		And (payBillsData.SUSPEND_REASON is null or payBillsData.SUSPEND_REASON ='')
		And payBillsData.PAYMENT_REQ_NO in (select payPayment.PAYMENT_REQ_NO from TB_PAY_PAYMENT payPayment
where payPayment.PAYMENT_REQ_NO = payBillsData.PAYMENT_REQ_NO and  payPayment.status='N')
	</select>
	
	<!--************************************************************************************************************-->
	<!--************************************************************************************************************-->
	<!--************************************************************************************************************-->
	<select id="selectLieData" resultType="com.foya.noms.dto.pay.TbPayPaymentRequestDTO">
		select Max(B.payment_req_end_date) PAYMENT_REQ_END_DATE,A.contract_no 
			from TB_PAY_PAYMENT_REQUEST A,TB_PAY_PAYMENT_REQUEST_DTL B,TB_PAY_CASH_REQUIREMENT C 
			where A.payment_req_no=B.payment_req_no and
			A.cash_req_no=C.cash_req_no and
			C.cash_req_no like 'L%'  and
			C.status in ('F' ,'G') 
			and A.contract_no not like 'NST%'
			group by A.contract_no
	</select>
	<select id="getLieAmt" resultType="com.foya.noms.dto.pay.TbPayPaymentRequestDTO">
		select SUM(B.tax_exclusive_amt) s_tax_exclusive_amt,SUM(B.business_tax) 
			s_business_tax,SUM(B.tax_exclusive_amt +B.business_tax) s_amt, 
			C.domain,A.contract_no,B.location_id locationId,count(A.contract_no) lieCnt
			from TB_PAY_PAYMENT_REQUEST A,TB_PAY_PAYMENT_REQUEST_DTL  
			B,TB_PAY_CASH_REQUIREMENT C 
			where A.payment_req_no=B.payment_req_no and
			A.cash_req_no=C.cash_req_no and
			C.cash_req_no like 'L%' and
			C.status in ('F' ,'G') and
			B.payment_req_no=D.payment_req_no and 
			B.item_no=D.payment_req_item_no and
			A.contract_no = #{contractNo} and
			B.payment_req_begin_date between #{sDate} and #{eDate} and
			B.payment_req_end_date between #{sDate} and #{eDate} 
			and A.contract_no not like 'NST%'
			 group by C.domain,A.contract_no,B.location_id
	</select>
	<select id="selectEleData" resultType="com.foya.noms.dto.pay.TbPayPaymentRequestDTO">
		select Max(B.payment_req_end_date) PAYMENT_REQ_END_DATE,A.contract_no 
			from TB_PAY_PAYMENT_REQUEST A,TB_PAY_PAYMENT_REQUEST_DTL B,TB_PAY_CASH_REQUIREMENT C 
			where A.payment_req_no=B.payment_req_no and
			A.cash_req_no=C.cash_req_no and
			C.cash_req_no like 'E%'  and
			C.status in ('F' ,'G') 
			group by A.contract_no
	</select>
	<select id="getEleAmt" resultType="com.foya.noms.dto.pay.TbPayPaymentRequestDTO">
		select SUM(B.tax_exclusive_amt) as s_tax_exclusive_amt,SUM(B.business_tax) 
			as s_business_tax,SUM(B.tax_exclusive_amt +B.business_tax) as s_amt, 
			C.domain,A.contract_no,B.location_id as locationId,D.electricity_type electricityType,D.electricity_meter_nbr as electricityMeterNbr
			from TB_PAY_PAYMENT_REQUEST A,TB_PAY_PAYMENT_REQUEST_DTL  
			B,TB_PAY_CASH_REQUIREMENT C ,TB_PAY_ELECTRICITY D
			where A.payment_req_no=B.payment_req_no and
			A.cash_req_no=C.cash_req_no and
			C.cash_req_no like 'E%' and
			C.status in ('F' ,'G') and
			B.payment_req_no=D.payment_req_no and 
			B.item_no=D.payment_req_item_no and
			D.use_type='E' and		
			A.contract_no = #{contractNo} and	
			B.payment_req_begin_date between #{sDate} and #{eDate} and
			B.payment_req_end_date between #{sDate} and #{eDate} 
			 group by C.domain,A.contract_no,B.location_id,D.electricity_type,D.electricity_meter_nbr
	</select>
	<select id="getLinePurpose" resultType="java.lang.String" parameterType="java.lang.String">
		select D.name from TB_SITE_LINE_APPLY C,TB_SYS_LOOKUP D 
             where C.line_purpose=D.code and C.Line_status='L02' 
             and C.line_id=#{lineId} 
             and D.type='CIRCUIT_USES'
	</select>
</mapper>