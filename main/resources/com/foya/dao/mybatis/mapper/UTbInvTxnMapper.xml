<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foya.dao.mybatis.mapper.UTbInvTxnMapper">
  <resultMap id="BaseResultMap" type="com.foya.noms.dto.inv.TbInvTxnDTO">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Nov 24 10:12:29 CST 2014.
    -->
    <id column="inv_txn_no" jdbcType="BIGINT" property="inv_txn_no" />
    <result column="txn_type" jdbcType="TINYINT" property="txn_type" />
    <result column="txn_type_name" jdbcType="VARCHAR" property="txn_type_name" />
    <result column="txn_no" jdbcType="VARCHAR" property="txn_no" />
    <result column="wh_id" jdbcType="VARCHAR" property="wh_id" />
     <result column="wh_name" jdbcType="VARCHAR" property="wh_name" />
    <result column="site_id" jdbcType="VARCHAR" property="site_id" />
    <result column="site_name" jdbcType="VARCHAR" property="site_name" />
    <result column="order_no" jdbcType="VARCHAR" property="order_no" />
     <result column="dept_name" jdbcType="VARCHAR" property="dept_name" />
    <result column="ref_act_no" jdbcType="VARCHAR" property="ref_act_no" />
    <result column="mat_no" jdbcType="VARCHAR" property="mat_no" />
    <result column="mat_status" jdbcType="TINYINT" property="mat_status" />
    <result column="qty" jdbcType="INTEGER" property="qty" />
    <result column="fa_no" jdbcType="VARCHAR" property="fa_no" />
    <result column="srl_no" jdbcType="BIGINT" property="srl_no" />
    <result column="rn_resn" jdbcType="VARCHAR" property="rn_resn" />
    <result column="rn_memo" jdbcType="VARCHAR" property="rn_memo" />
    <result column="cr_user" jdbcType="VARCHAR" property="cr_user" />
    <result column="cr_name" jdbcType="VARCHAR" property="cr_name" />
    <result column="cr_time" jdbcType="TIMESTAMP" property="cr_time" />
    <result column="po_no" jdbcType="VARCHAR" property="po_no" />
    <result column="po_line_nbr" jdbcType="SMALLINT" property="po_line_nbr" />
    <result column="tagNo" jdbcType="VARCHAR" property="tagNo" />
    <result column="venSn" jdbcType="VARCHAR" property="venSn" />
    <result column="appUserName" jdbcType="VARCHAR" property="appUserName" />
    <result column="matName" jdbcType="VARCHAR" property="matName" />
    <result column="appTime" jdbcType="TIMESTAMP" property="appTime" />
    <result column="matStatusDscr" jdbcType="VARCHAR" property="matStatusDscr" />
    <result column="rtnReasonDscr" jdbcType="VARCHAR" property="rtnReasonDscr" />
    <result column="mrQty" jdbcType="INTEGER" property="mrQty" />
    <result column="btsSiteId" property="btsSiteId" />
  </resultMap>
  
  <!-- InvDao Begin (待修改) -->
  <resultMap id="ResultMap_InvTxn" type="com.foya.dao.mybatis.model.TbInvTxn">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Nov 28 10:54:07 CST 2014.
    -->
    <id column="inv_txn_no" jdbcType="BIGINT" property="inv_txn_no" />
    <result column="txn_type" jdbcType="TINYINT" property="txn_type" />
    <result column="txn_no" jdbcType="VARCHAR" property="txn_no" />
    <result column="wh_id" jdbcType="VARCHAR" property="wh_id" />
    <result column="site_id" jdbcType="VARCHAR" property="site_id" />
    <result column="order_no" jdbcType="VARCHAR" property="order_no" />
    <result column="ref_act_no" jdbcType="VARCHAR" property="ref_act_no" />
    <result column="mat_no" jdbcType="VARCHAR" property="mat_no" />
    <result column="mat_status" jdbcType="TINYINT" property="mat_status" />
    <result column="qty" jdbcType="INTEGER" property="qty" />
    <result column="fa_no" jdbcType="VARCHAR" property="fa_no" />
    <result column="srl_no" jdbcType="BIGINT" property="srl_no" />
    <result column="rn_resn" jdbcType="VARCHAR" property="rn_resn" />
    <result column="rn_memo" jdbcType="VARCHAR" property="rn_memo" />
    <result column="cr_user" jdbcType="VARCHAR" property="cr_user" />
    <result column="cr_time" jdbcType="TIMESTAMP" property="cr_time" />
    <result column="po_no" jdbcType="VARCHAR" property="po_no" />
    <result column="po_line_nbr" jdbcType="SMALLINT" property="po_line_nbr" />
    <result column="tr_dtl_no" jdbcType="BIGINT" property="tr_dtl_no" />
  </resultMap>
 <select id="selectInvTxnByTempWh" resultMap="ResultMap_InvTxn" parameterType="com.foya.dao.mybatis.model.TbInvTxn" >
		<!--select *
		from TB_INV_TXN
		<where>           
		    wh_id in (select w.wh_id from TB_INV_WAREHOUSE w where w.wh_attribute='T') 
            <if test="txn_type != null" >
        		And txn_type = #{record.txn_type,jdbcType=TINYINT}
      		</if>
      		<if test="site_id != null" >
        		And site_id = #{record.site_id,jdbcType=VARCHAR}
      		</if>
      		<if test="order_no != null" >
        		And order_no = #{record.order_no,jdbcType=VARCHAR}
      		</if>
        </where>-->
        select a.*
  		from tb_inv_txn a
  		left join (select * 
               from tb_inv_txn 
              	where txn_type=2) b
		on a.order_no = b.order_no 
   		and a.mat_no = b.mat_no
 		where a.txn_type=1
  		and b.txn_no is null
		<if test="site_id != null" >
        		And a.site_id = #{site_id,jdbcType=VARCHAR}
      	</if>
      	<if test="order_no != null" >
        		And a.order_no = #{order_no,jdbcType=VARCHAR}
      	</if>
	</select>
	<select id="getRtnWhIdBySiteIdAndOrderNo" resultMap="ResultMap_InvTxn" parameterType="com.foya.dao.mybatis.model.TbInvTxn" >
		select *
		from TB_INV_TXN
		<where>           
		    
            <if test="txn_type != null" >
        		And txn_type = #{txn_type,jdbcType=TINYINT}
      		</if>
      		<if test="site_id != null" >
        		And site_id = #{site_id,jdbcType=VARCHAR}
      		</if>
      		<if test="order_no != null" >
        		And order_no = #{order_no,jdbcType=VARCHAR}
      		</if>
      		<if test="mat_no != null" >
        		And mat_no = #{mat_no,jdbcType=VARCHAR}
      		</if>
      		<if test="fa_no != null" >
        		And fa_no = #{fa_no,jdbcType=VARCHAR}
      		</if>
      		
        </where>
	</select>
	
	<!-- InvDao end(待修改) -->
	
  <select id="searchInvTxnJoinSiteTxn" resultMap="BaseResultMap" parameterType="map">
    select a.site_name,a.wh_name,a.txn_no,a.dept_name,a.cr_time,s.name as txn_type_name ,p.chn_NM as cr_name
    from (
			  select txn_type,(select site_name  from tb_site_main where SITE_ID=tb_inv_txn.site_id )as site_name ,(select wh_name  from tb_inv_warehouse where wh_id=tb_inv_txn.wh_id  )as wh_name,txn_no,
			  	case  when  (txn_type=1  or txn_type=2) then (select rep_dept from TB_SITE_WORK_ORDER where order_id= TB_INV_TXN .order_no) else '' end  as dept_name,
			  	cr_user ,cr_time  
			  	from tb_inv_txn 
			  	<where>
			  	    <if test="crStartDate != null and crStartDate != '' and crEndDate != null and crEndDate != ''" >
						and   CR_TIME BETWEEN  CONVERT(DATETIME,#{crStartDate,jdbcType=VARCHAR},121)  
						AND  CONVERT(DATETIME,#{crEndDate,jdbcType=VARCHAR},121)
					</if>
					<if test="srl_no != null and srl_no != ''" >
			  	     and srl_no=#{srl_no,jdbcType=VARCHAR}
			  	     </if>
			  	</where> 
				union all 
				select txn_type ,'','',txn_no,(select d.dept_name  from TB_SITE_WORK_ORDER o,TB_ORG_DEPT d  
				where o.order_id= TB_INV_SITE_TXN.order_no and o.rep_dept =d.dept_id ),cr_user,cr_time  
				from TB_INV_SITE_TXN
				<where>
			  	    <if test="crStartDate != null and crStartDate != '' and crEndDate != null and crEndDate != ''" >
						and   CR_TIME BETWEEN  CONVERT(DATETIME,#{crStartDate,jdbcType=VARCHAR},121)  
						AND  CONVERT(DATETIME,#{crEndDate,jdbcType=VARCHAR},121)
					</if>
					 <if test="srl_no != null and srl_no != ''" >
			  	     and srl_no=#{srl_no,jdbcType=VARCHAR}
			  	     </if>
			  	</where>
	) a ,TB_SYS_LOOKUP s,TB_AUTH_PERSONNEL p
	where s.type='INV_TXN_TYPE'  
	 and s.code=a.txn_type  
	and p.psn_no=a.cr_user
      	
	
  </select>

	<select id="searchWithInvSrl" resultMap="BaseResultMap"
		parameterType="hashmap">
		select a.*,(select tag_no from TB_INV_SRL where srl_no=a.srl_no) tagNo,
		(select ven_sn from TB_INV_SRL where srl_no=a.srl_no) venSn,
		(select wh_name from TB_INV_WAREHOUSE where wh_id=a.wh_id) wh_name,
		(select chn_nm from tb_auth_personnel where psn_no=a.send_rcv_user) appUserName
		from TB_INV_TXN a
		where ref_act_no=#{optId}
		<!-- <if test="matNo !=null and matNo!='' ">
			and mat_no=#{matNo}
		</if> -->
		<if test="dtlSeq !=null and dtlSeq!='' ">
			and dtl_seq=#{dtlSeq}
		</if>
		and txn_type='1'
	</select>
  
  	<select id="searchWithInvSrlByTxnNo" resultMap="BaseResultMap"
		parameterType="hashmap">
		select a.txn_no,a.ref_act_no,a.mat_no,ABS(a.qty) qty,a.srl_no,(select mat_name from tb_inv_material where mat_no=a.mat_no) matName,
		(select tag_no from TB_INV_SRL where srl_no=a.srl_no) tagNo,
		(select ven_sn from TB_INV_SRL where srl_no=a.srl_no) venSn,
		(select fa_no from TB_INV_SRL where srl_no=a.srl_no) fa_no,
		(select wh_name from TB_INV_WAREHOUSE where wh_id=a.wh_id) wh_name,
		cr_time,(select chn_nm from tb_auth_personnel where psn_no=a.send_rcv_user) crUser
		from TB_INV_TXN a
		where ref_act_no=#{txnNo}
		and txn_type=#{txnType}
		<!-- and mat_no=#{matNo} -->
		and dtl_seq=#{dtlSeq}
	</select>
	
	  <select id="searchInvTxn" resultMap="BaseResultMap" parameterType="hashmap">
		select 
			a.txn_no,
			<!-- a.cr_time, -->
			convert(char, a.cr_time, 111) crTime,
			a.cr_user,
			a.wh_id,
			a.site_id,
			(select DISTINCT chn_nm from tb_auth_personnel where psn_no=a.cr_user) cr_name,
			(select DISTINCT wh_name from TB_INV_WAREHOUSE where wh_id=a.wh_id) wh_name,
			(select DISTINCT site_name from tb_site_main where site_id=a.site_id) site_name
		from TB_INV_TXN a
		where 
			txn_type=#{txnType}
		<if test="crSDate !=null and crSDate!='' and crEDate !=null and crEDate!='' ">
			<!-- and cr_time between #{crSDate} and #{crEDate} -->
			and a.cr_time &gt;= #{crSDate} And a.cr_time &lt;= #{crEDate}
		</if>
		<if test="crUser !=null and crUser!='' ">
			and send_rcv_user=#{crUser}
		</if>
		<if test="txnNo !=null and txnNo!='' ">
			<!-- and ref_act_no=#{txnNo} -->
			and txn_no like '%'+#{txnNo}+'%'
		</if>
		<if test="whId !=null and whId!='' ">
			and wh_id=#{whId}
		</if>
		<if test="siteId !=null and siteId!='' ">
			and site_id like '%'+#{siteId}+'%'
		</if>
		group by a.txn_no,convert(char, a.cr_time, 111),cr_user,wh_id,site_id
	</select>
	
	<!--INV012L - 搜尋TxnDetail -->
	<select id="searchInvTxnPrintPageDetail" resultMap="BaseResultMap" parameterType="hashmap">
		select 
			a.ref_act_no,
			a.site_id,
			ABS(a.qty) qty,
			a.order_no,
			(select tag_no from TB_INV_SRL where srl_no=a.srl_no) tagNo,
			(select ven_sn from TB_INV_SRL where srl_no=a.srl_no) venSn,
			(select wh_name from TB_INV_WAREHOUSE where wh_id=a.wh_id) wh_name,
			(select dept_name from tb_org_dept 
				where dept_id =
						(select dept_id from TB_AUTH_PERSONNEL where psn_no= (select app_user from tb_inv_material_opt where opt_type='MRQ' and opt_id=a.ref_act_no))
			) dept_name,
			((select chn_nm from tb_auth_personnel 
				where psn_no=a.send_rcv_user) 
			) appUserName,
			(select site_name from tb_site_main where site_id=a.site_id) site_name,
			(select BTS_SITE_ID from tb_site_main where site_id=a.site_id) btsSiteId,
			(select mat_name from tb_inv_material where mat_no=a.mat_no) matName,
			a.mat_no
		from TB_INV_TXN a
		where 
			txn_no=#{txnNo}
			and txn_type='1'
			order by mat_no
	</select>
	
	<select id="selerctMaxSeq" resultMap="BaseResultMap" parameterType="hashmap">
		select max(SUBSTRing(txn_no,4,13)) txn_no from TB_INV_TXN 
		 where	1=1
	    <if test="txnNo!=null and txnNo!=''" >
	        and SUBSTRing(txn_no,4,13) like '%'+#{txnNo}+'%'
	        and txn_no like #{prefix}+'%'
	    </if>
	</select>
	
	<select id="searchInvTxnRef" resultMap="BaseResultMap"
		parameterType="hashmap">
		select a.ref_act_no,a.mat_no,(select mat_name from tb_inv_material where mat_no=a.mat_no) matName,
		(select dept_name from tb_org_dept where dept_id =(select dept_id from TB_AUTH_PERSONNEL where psn_no=
			(select app_user from tb_inv_material_opt where opt_type='RTN' and opt_id=a.ref_act_no))) dept_name,
		((select chn_nm from tb_auth_personnel where psn_no=
			(select app_user from tb_inv_material_opt where opt_type='RTN' and opt_id=a.ref_act_no)) 
		) appUserName,
		(select site_name from tb_site_main where site_id=a.site_id) site_name,a.site_id,order_no,
		(select tag_no from tb_inv_srl where srl_no=a.srl_no) tagNo,
		(select ven_sn from tb_inv_srl where srl_no=a.srl_no) venSN,
		a.mat_status,a.qty,(select name from TB_SYS_LOOKUP where type='MAT_STATUS' and code=a.mat_status) matStatusDscr
		from TB_INV_TXN a
		where txn_no=#{txnNo}
	</select>
	
	<select id="searchInvTxnRTN" resultMap="BaseResultMap"
		parameterType="hashmap">
		select a.ref_act_no,a.mat_no,(select mat_name from tb_inv_material where mat_no=a.mat_no) matName,
		a.qty,(select name from TB_SYS_LOOKUP where type='MAT_STATUS' and code=(select mat_status from tb_inv_rt_d where opt_id=a.ref_act_no and a.opt_type='RTN')) matStatusDscr,
		(select name from TB_SYS_LOOKUP where type='INV_RN_RESN' and code=(select rtn_reason from tb_inv_rt_d where opt_id=a.ref_act_no and a.opt_type='RTN')) rtnReasonDscr,
		(select qty from tb_inv_rt_d where opt_id=a.ref_act_no and a.opt_type='RTN') rtnQty,
		(select sum(qty) from tb_inv_txn where mat_no=a.mat_no and ref_act_no=a.ref_act_no and txn_type='2' and txn_no=#{txnNo} and wh_id=#{whId} 
		and dtl_seq=tb_inv_rt_d.dtl_seq group by ref_act_no,mat_no,dtl_seq) txnQty,
		(select tag_no from tb_inv_srl where srl_no=a.srl_no) tagNo,
		(select ven_sn from tb_inv_srl where srl_no=a.srl_no) venSN,
		a.mat_status,a.qty,(select name from TB_SYS_LOOKUP where type='MAT_STATUS' and code=a.mat_status) matStatusDscr
		from TB_INV_TXN a
		where txn_no=#{txnNo}
	</select>
	
	<!--**********************************************************************************************************-->
	<sql id="tbInvTxnColumns">
		TB_INV_TXN.inv_txn_no,
		TB_INV_TXN.txn_type,
		TB_INV_TXN.txn_no,
		TB_INV_TXN.wh_id,
		TB_INV_TXN.site_id,
		TB_INV_TXN.order_no,
		TB_INV_TXN.ref_act_no,
		TB_INV_TXN.mat_no,
		TB_INV_TXN.mat_status,
		TB_INV_TXN.qty,
		TB_INV_TXN.fa_no,
		TB_INV_TXN.srl_no,
		TB_INV_TXN.rn_resn,
		TB_INV_TXN.rn_memo,
		TB_INV_TXN.cr_user,
		TB_INV_TXN.cr_time,
		TB_INV_TXN.po_no,
		TB_INV_TXN.po_line_nbr,
		TB_INV_TXN.tr_dtl_no,
		TB_INV_TXN.dtl_seq,
		TB_INV_TXN.mro_rt_user
	</sql>
	
	<sql id="tbInvSrlColumns">
		TB_INV_SRL.srl_no as srl_no2,
		TB_INV_SRL.wh_id as wh_id2,
		TB_INV_SRL.mat_no as mat_no2,
		TB_INV_SRL.ven_sn,
		TB_INV_SRL.fa_no as fa_no2,
		TB_INV_SRL.rcv_date,
		TB_INV_SRL.mat_status as mat_status2,
		TB_INV_SRL.site_id as site_id2,
		TB_INV_SRL.discard_date,
		TB_INV_SRL.discard_no,
		TB_INV_SRL.cr_user as cr_user2,
		TB_INV_SRL.cr_time as cr_time2,
		TB_INV_SRL.md_user as md_user2,
		TB_INV_SRL.md_time as md_time2,
		TB_INV_SRL.tag_no
	</sql>
	
	<sql id="tbInvRtDColumns">
		TB_INV_RT_D.DTL_SEQ as dtl_seq3,
		TB_INV_RT_D.OPT_ID,
		TB_INV_RT_D.MAT_NO as mat_no3,
		TB_INV_RT_D.SRL_NO as srl_no3,
		TB_INV_RT_D.QTY as qty3,
		TB_INV_RT_D.MAT_STATUS as mat_status3,
		TB_INV_RT_D.RTN_REASON,
		TB_INV_RT_D.CR_USER as cr_user3,
		TB_INV_RT_D.CR_TIME as cr_time3,
		TB_INV_RT_D.MD_USER as md_user3,
		TB_INV_RT_D.MD_TIME as md_time3
	</sql>
	
	<resultMap id="tbInvTxnMap" type="com.foya.noms.dto.inv.TbInvTxnDTO">
	    <id column="inv_txn_no" property="inv_txn_no" />
	    <result column="txn_type" property="txn_type" />
	    <result column="txn_no" property="txn_no" />
	    <result column="wh_id" property="wh_id" />
	    <result column="site_id" property="site_id" />
	    <result column="order_no" property="order_no" />
	    <result column="ref_act_no" property="ref_act_no" />
	    <result column="mat_no" property="mat_no" />
	    <result column="mat_status" property="mat_status" />
	    <result column="qty" property="qty" />
	    <result column="fa_no" property="fa_no" />
	    <result column="srl_no" property="srl_no" />
	    <result column="rn_resn" property="rn_resn" />
	    <result column="rn_memo" property="rn_memo" />
	    <result column="cr_user" property="cr_user" />
	    <result column="cr_time" property="cr_time" />
	    <result column="po_no" property="po_no" />
	    <result column="po_line_nbr" property="po_line_nbr" />
	    <result column="tr_dtl_no" property="tr_dtl_no" />
	    <result column="dtl_seq" property="dtl_seq" />
	    <result column="mro_rt_user" property="mro_rt_user" />
	    
	    <result column="btsSiteId" property="btsSiteId" />
	    <result column="wh_name" property="wh_name" />
	    <result column="dept_name" property="dept_name" />
	    <result column="site_name" property="site_name" />
	    <result column="matName" property="matName" />
	    <result column="appUserName" property="appUserName" />
	    <association property="invSrl" column="srl_no"
			javaType="com.foya.dao.mybatis.model.TbInvSrl" resultMap="tbInvSrlMap" />
		<association property="invRtD" column="mat_no"
			javaType="com.foya.dao.mybatis.model.TbInvRtD" resultMap="tbInvRtDMap" />
  	</resultMap>
  	
  	<resultMap id="tbInvTxnMap2" type="com.foya.noms.dto.inv.TbInvTxnDTO">
	    <id column="inv_txn_no" property="inv_txn_no" />
	    <result column="txn_type" property="txn_type" />
	    <result column="txn_no" property="txn_no" />
	    <result column="wh_id" property="wh_id" />
	    <result column="site_id" property="site_id" />
	    <result column="order_no" property="order_no" />
	    <result column="ref_act_no" property="ref_act_no" />
	    <result column="mat_no" property="mat_no" />
	    <result column="mat_status" property="mat_status" />
	    <result column="qty" property="qty" />
	    <result column="fa_no" property="fa_no" />
	    <result column="srl_no" property="srl_no" />
	    <result column="rn_resn" property="rn_resn" />
	    <result column="rn_memo" property="rn_memo" />
	    <result column="cr_user" property="cr_user" />
	    <result column="cr_time" property="cr_time" />
	    <result column="po_no" property="po_no" />
	    <result column="po_line_nbr" property="po_line_nbr" />
	    <result column="tr_dtl_no" property="tr_dtl_no" />
	    <result column="dtl_seq" property="dtl_seq" />
	    <result column="mro_rt_user" property="mro_rt_user" />
	    
	    <result column="wh_name" property="wh_name" />
	    <result column="dept_name" property="dept_name" />
	    <result column="site_name" property="site_name" />
	    <result column="matName" property="matName" />
	    <result column="appUserName" property="appUserName" />
<!-- 	    <association property="invSrl" column="srl_no" -->
<!-- 			javaType="com.foya.dao.mybatis.model.TbInvSrl" resultMap="tbInvSrlMap" /> -->
<!-- 		<association property="invRtD" column="mat_no" -->
<!-- 			javaType="com.foya.dao.mybatis.model.TbInvRtD" resultMap="tbInvRtDMap" /> -->
  	</resultMap>

  	<resultMap id="tbInvSrlMap" type="com.foya.dao.mybatis.model.TbInvSrl">
	    <id column="srl_no2" property="srl_no" />
	    <result column="wh_id2" property="wh_id" />
	    <result column="mat_no2" property="mat_no" />
	    <result column="ven_sn" property="ven_sn" />
	    <result column="fa_no2" property="fa_no" />
	    <result column="rcv_date" property="rcv_date" />
	    <result column="mat_status2" property="mat_status" />
	    <result column="site_id2" property="site_id" />
	    <result column="discard_date" property="discard_date" />
	    <result column="discard_no" property="discard_no" />
	    <result column="cr_user2" property="cr_user" />
	    <result column="cr_time2" property="cr_time" />
	    <result column="md_user2" property="md_user" />
	    <result column="md_time2" property="md_time" />
	    <result column="tag_no" property="tag_no" />
  	</resultMap>
  	
  	<resultMap id="tbInvRtDMap" type="com.foya.dao.mybatis.model.TbInvRtD">
	    <id column="dtl_seq3" property="DTL_SEQ" />
	    <result column="OPT_ID" property="OPT_ID" />
	    <result column="mat_no3" property="MAT_NO" />
	    <result column="srl_no3" property="SRL_NO" />
	    <result column="qty3" property="QTY" />
	    <result column="mat_status3" property="MAT_STATUS" />
	    <result column="RTN_REASON" property="RTN_REASON" />
	    <result column="cr_user3" property="CR_USER" />
	    <result column="cr_time3" property="CR_TIME" />
	    <result column="md_user3" property="MD_USER" />
	    <result column="md_time3" property="MD_TIME" />
  	</resultMap>
	
	<!-- 搜尋收料詳細資料 -->
	<select id="getInvTxnData" resultMap="tbInvTxnMap">
		Select 
			<include refid="tbInvTxnColumns" />
			,
			<include refid="tbInvSrlColumns" />
			,
			<include refid="tbInvRtDColumns" />
			,
			material.mat_name as matName
			,
			TB_SITE_MAIN.SITE_NAME as site_name
			,
			TB_SITE_MAIN.BTS_SITE_ID as btsSiteId
			,
			TB_AUTH_PERSONNEL.CHN_NM as appUserName
			,
			TB_ORG_DEPT.DEPT_NAME as dept_name
			,
			TB_INV_WAREHOUSE.wh_name
		From TB_INV_TXN
		Left Join TB_INV_SRL
		ON
		TB_INV_TXN.srl_no = TB_INV_SRL.srl_no
		Left Join TB_INV_RT_D
		ON
		TB_INV_TXN.mat_no = TB_INV_RT_D.MAT_NO
		And
		TB_INV_TXN.ref_act_no = TB_INV_RT_D.OPT_ID
		Left Join TB_INV_MATERIAL as material
		ON
		TB_INV_TXN.mat_no = material.mat_no
		Left Join TB_SITE_MAIN
		ON
		TB_INV_TXN.site_id = TB_SITE_MAIN.SITE_ID
		Left Join TB_INV_MATERIAL_OPT
		ON
		TB_INV_TXN.ref_act_no = TB_INV_MATERIAL_OPT.OPT_ID
		Left Join TB_AUTH_PERSONNEL
		ON
		TB_INV_MATERIAL_OPT.APP_USER=TB_AUTH_PERSONNEL.PSN_NO
		Left Join TB_ORG_DEPT
		ON TB_AUTH_PERSONNEL.DEPT_ID = TB_ORG_DEPT.DEPT_ID
		Left Join TB_INV_WAREHOUSE
		ON
		TB_INV_TXN.wh_id = TB_INV_WAREHOUSE.wh_id
		Where
			TB_INV_TXN.txn_type='2'
		<if test="createUser != null and createUser != ''">
			And TB_INV_TXN.send_rcv_user = #{createUser}
		</if>
		<if test="strDate != null and endDate != null">
			And TB_INV_TXN.cr_time &gt;= #{strDate} And TB_INV_TXN.cr_time &lt;= #{endDate}
		</if>
		<if test="txnNo != null and txnNo != ''">
			And TB_INV_TXN.txn_no = #{txnNo}
		</if>
		<if test="whId != null and whId != ''">
			And TB_INV_TXN.wh_id = #{whId}
		</if>
	</select>
	
	<!-- 搜尋收料詳細資料 -->
	<select id="getInvTxnDataByGroup" resultMap="tbInvTxnMap2">
		Select 
			a.txn_no,
			(select DISTINCT chn_nm from tb_auth_personnel where psn_no=a.send_rcv_user) appUserName,
			(select DISTINCT wh_name from TB_INV_WAREHOUSE where wh_id=a.wh_id) wh_name,
			convert(char, a.cr_time, 111) crTime
		From TB_INV_TXN a
		<!-- Left Join TB_AUTH_PERSONNEL as personnel
		ON
		TB_INV_TXN.send_rcv_user = personnel.PSN_NO
		Left Join TB_INV_WAREHOUSE as warehouse
		ON
		TB_INV_TXN.wh_id = warehouse.wh_id -->
		Where
			a.txn_type='2'
		<if test="createUser != null and createUser != ''">
			And a.send_rcv_user = #{createUser}
		</if>
		<if test="strDate != null and endDate != null">
			And a.cr_time &gt;= #{strDate} And a.cr_time &lt;= #{endDate}
		</if>
		<if test="txnNo != null and txnNo != ''">
			<!-- And TB_INV_TXN.txn_no = #{txnNo} -->
			and a.txn_no like '%'+#{txnNo}+'%'
		</if>
		<if test="whId != null and whId != ''">
			And a.wh_id = #{whId}
		</if>
		group by a.txn_no,convert(char, a.cr_time, 111),a.send_rcv_user,a.wh_id
	</select>
	<!--**********************************************************************************************************-->
	<select id="searchRTDetail" resultMap="BaseResultMap" parameterType="map">
		select txn_no,cr_time,qty,(select chn_nm from tb_auth_personnel where psn_no=cr_user) crUser
		from tb_inv_txn
		where txn_type='2'
		and ref_act_no=#{optId}
		and mat_no=#{matNo}
		and dtl_seq=#{dtlSeq}
	</select>
	
	<select id="searchTxnMRSumQty" parameterType="map" resultType="java.lang.Integer">
		select ABS(sum(qty)) mrQty
		from tb_inv_txn
		where txn_type=#{txnType}
		and ref_act_no=#{refActNo}
		<!-- and mat_no=#{matNo} -->
		and dtl_seq=#{dtlSeq}
		group by ref_act_no,dtl_seq
	</select>
	<select id="searchWithTxnNoForSp1" resultMap="BaseResultMap"
		parameterType="hashmap">
		select txn_no,a.mat_no,a.qty ,(select mat_name from tb_inv_material where mat_no=a.mat_no) matName,
		(select tag_no from TB_INV_SRL where srl_no=a.srl_no) tagNo,
		(select ven_sn from TB_INV_SRL where srl_no=a.srl_no) venSn,cr_time
		from TB_INV_TXN a
		where txn_no=#{txnNo}
	</select>
	
	<select id="searchLessQty" resultMap="BaseResultMap">
		select ref_act_no<!-- ,mat_no -->,ABS(sum(qty)) qty
			from TB_INV_TXN
			where txn_type=#{txnType}
			and ref_act_no =#{optId}
			<!-- and mat_no = #{matNo} -->
			group by ref_act_no<!-- ,mat_no -->			
			<!-- <![CDATA[having ABS(sum(qty)) < #{qty} ]]> -->
			order by ref_act_no<!-- ,mat_no -->
	</select>
	<select id="searchTxnQty" parameterType="map" resultMap="BaseResultMap">
		select ABS(sum(qty)) mrQty,dtl_seq
		from tb_inv_txn
		where <!-- dtl_seq= TB_INV_MR_D.dtl_seq
		and --> txn_type=#{txnType}
		and ref_act_no=#{refActNo}
		and mat_no=#{matNo}
		group by ref_act_no,mat_no,dtl_seq
	</select>
	
		<select id="searchTxnRTQty" parameterType="map" resultMap="BaseResultMap">
		select ABS(sum(qty)) mrQty,dtl_seq
		from tb_inv_txn
		where <!-- dtl_seq= TB_INV_RT_D.dtl_seq
		and --> txn_type=#{txnType}
		and ref_act_no=#{refActNo}
		and mat_no=#{matNo}
		group by ref_act_no,mat_no,dtl_seq
	</select>
	
	<select id="searchCloseTxnQty" parameterType="map" resultMap="BaseResultMap">
		select ABS(sum(qty)) mrQty
		from tb_inv_txn
		where txn_type=#{txnType}
		and ref_act_no=#{refActNo}
		and mat_no=#{matNo}
		and wh_id=#{whId}
		group by ref_act_no,mat_no
	</select>
</mapper>