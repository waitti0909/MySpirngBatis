<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foya.dao.mybatis.mapper.UTbSiteWorkOrderMapper">
  <resultMap id="BaseResultMap" type="com.foya.noms.dto.st.SiteWorkOrderDTO">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Oct 29 14:19:46 CST 2014.
    -->
    <id column="ORDER_ID" jdbcType="VARCHAR" property="ORDER_ID" />
    <result column="ORDER_TYPE" jdbcType="VARCHAR" property="ORDER_TYPE" />
    <result column="WORK_ID" jdbcType="VARCHAR" property="WORK_ID" />
    <result column="ODR_SEQ" jdbcType="INTEGER" property="ODR_SEQ" />
    <result column="PRIORITY" jdbcType="CHAR" property="PRIORITY" />
    <result column="ODR_STATUS" jdbcType="VARCHAR" property="ODR_STATUS" />
    <result column="REP_DEPT" jdbcType="VARCHAR" property="REP_DEPT" />
    <result column="REP_USER" jdbcType="VARCHAR" property="REP_USER" />
    <result column="ASSIGN_TIME" jdbcType="TIMESTAMP" property="ASSIGN_TIME" />
    <result column="PICK_USER" jdbcType="VARCHAR" property="PICK_USER" />
    <result column="PICK_TIME" jdbcType="TIMESTAMP" property="PICK_TIME" />
    <result column="END_USER" jdbcType="VARCHAR" property="END_USER" />
    <result column="END_TIME" jdbcType="TIMESTAMP" property="END_TIME" />
    <result column="END_DESC" jdbcType="VARCHAR" property="END_DESC" />
    <result column="CR_USER" jdbcType="VARCHAR" property="CR_USER" />
    <result column="CR_TIME" jdbcType="TIMESTAMP" property="CR_TIME" />
    <result column="MD_USER" jdbcType="VARCHAR" property="MD_USER" />
    <result column="MD_TIME" jdbcType="TIMESTAMP" property="MD_TIME" />
    <result column="IS_ACTIVE" jdbcType="VARCHAR" property="IS_ACTIVE" />
    <result column="REP_TEAM" jdbcType="VARCHAR" property="REP_TEAM" />
    
    
    <result column="OD_TYPE_NAME" jdbcType="VARCHAR" property="orderTypeName" />
    <result column="DEPT_NAME" jdbcType="VARCHAR" property="deptName" />
    
    <result column="BTS_SITE_ID" jdbcType="VARCHAR" property="btsSiteId" />
    <result column="SITE_NAME" jdbcType="VARCHAR" property="siteName" />
    <result column="CITY" jdbcType="VARCHAR" property="CITY" />
    <result column="AREA" jdbcType="VARCHAR" property="AREA" />
    <result column="WORK_TYPE" jdbcType="VARCHAR" property="WORK_TYPE" />
    <result column="OS_ID" jdbcType="VARCHAR" property="OS_ID" />
    <result column="APL_DEPT" jdbcType="VARCHAR" property="APL_DEPT" />
    <result column="APL_DEPT" jdbcType="VARCHAR" property="APL_DEPT" />
    <result column="AP_DATE" jdbcType="VARCHAR" property="AP_DATE" />
    <result column="OS_DESC" jdbcType="VARCHAR" property="OS_DESC" />
    
    <result column="OS_TIME" jdbcType="VARCHAR" property="OS_TIME" />
    <result column="APL_TIME" jdbcType="VARCHAR" property="APL_TIME" />
    <result column="EQP_TYPE" jdbcType="VARCHAR" property="EQP_TYPE" />
    <result column="STATUS" jdbcType="VARCHAR" property="STATUS" />
	<result column="CO_VAT_NO" jdbcType="VARCHAR" property="CO_VAT_NO" />
	<result column="ITEM_TYPE" jdbcType="VARCHAR" property="ITEM_TYPE" />
	<result column="PO_ID" jdbcType="VARCHAR" property="PO_ID" />
	<result column="PO_YEAR" jdbcType="VARCHAR" property="PO_YEAR" />
	<result column="SITE_ID" jdbcType="VARCHAR" property="siteId" />
	
	<result column="REP_TEAM_NAME" jdbcType="VARCHAR" property="REP_TEAM_NAME" />
	<result column="APL_USER_NAME" jdbcType="VARCHAR" property="APL_USER_NAME" />
	<result column="EQP_TYPE_NAME" jdbcType="VARCHAR" property="EQP_TYPE_NAME" />
	<result column="FEQ_ID" jdbcType="VARCHAR" property="FEQ_ID" />
	<result column="FEQ_NAME" jdbcType="VARCHAR" property="feqName" />
  </resultMap>
  
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 17 15:41:00 CST 2014.
    -->
    ORDER_ID, ORDER_TYPE, WORK_ID, ODR_SEQ, ORDER_DESC, PRIORITY, ODR_STATUS, REP_DEPT, 
    REP_TEAM, REP_USER, ASSIGN_TIME, PICK_USER, PICK_TIME, END_USER, END_TIME, END_DESC, 
    IS_ACTIVE, CR_USER, CR_TIME, MD_USER, MD_TIME
  </sql>
  
  
  <select id="selectSiteWorkOrderByWorkId" parameterType="java.lang.String" resultMap="BaseResultMap">
    select workOrder.ORDER_ID,orderType.OD_TYPE_NAME OD_TYPE_NAME,workOrder.IS_ACTIVE,
    dept.DEPT_NAME DEPT_NAME,workOrder.ODR_SEQ,workOrder.ODR_STATUS,workOrder.ORDER_TYPE
	from TB_SITE_WORK_ORDER workOrder
	left outer join TB_SYS_ORDER_TYPE orderType
	on workOrder.ORDER_TYPE = orderType.OD_TYPE_ID
	left outer join  TB_ORG_DEPT dept
	on workOrder.REP_DEPT = dept.DEPT_ID
    where workOrder.WORK_ID = #{workId}
  </select>
  
	 <select id="selectWorkOrderList" resultMap="BaseResultMap">
	 	select A.* from (
	   select DISTINCT
		    workOrder.ORDER_ID, workOrder.ORDER_TYPE, workOrder.WORK_ID, 
		    workOrder.ODR_SEQ, workOrder.PRIORITY, workOrder.ODR_STATUS, 
		    workOrder.REP_DEPT, workOrder.REP_TEAM, workOrder.REP_USER, workOrder.ASSIGN_TIME, 
		    workOrder.PICK_USER, workOrder.PICK_TIME, workOrder.END_USER, 
		    workOrder.END_TIME, workOrder.END_DESC, workOrder.CR_USER, 
		    workOrder.CR_TIME, workOrder.MD_USER, workOrder.MD_TIME, 
		    workOrder.IS_ACTIVE, work.BTS_SITE_ID, work.SITE_NAME,
		    work.SR_ID, work.WORK_TYPE, work.SITE_ID, work.APL_TIME
		    <if test="coVatNo !=null and coVatNo !=''">
		    ,outSourcing.CO_VAT_NO
		    </if>
		from TB_SITE_WORK_ORDER workOrder
		left outer join TB_SITE_WORK work
		on workOrder.work_ID = work.work_ID
		<if test="coVatNo !=null and coVatNo !=''">
		left outer join TB_SITE_OUTSOURCING outSourcing
		on workOrder.order_ID = outSourcing.order_ID
		</if>
	  	<where>
		<if test="orderId !=null and orderId !=''">
			and workOrder.ORDER_ID = #{orderId}
		</if>
		<if test="workId !=null and workId !=''">
			and workOrder.work_ID = #{workId}
		</if>
		<if test="orderType !=null and orderType!=''">
			and workOrder.ORDER_TYPE = #{orderType}
		</if>
		<if test="btsSiteId !=null and btsSiteId !=''">
			and work.BTS_SITE_ID = #{btsSiteId}
		</if>
		<if test="siteName !=null and siteName !=''">
			and work.SITE_NAME like '%'+#{siteName}+'%'
		</if>
		<if test="repDept !=null and repDept !=''">
			and (workOrder.REP_DEPT = #{repDept} or workOrder.REP_TEAM = #{repDept})
		</if>

		<if test="repUser !=null and repUser !=''">
			and workOrder.REP_USER = #{repUser}
		</if>
		<if test="siteWorkCity !=null and siteWorkCity !=''">
			and work.CITY = #{siteWorkCity}
		</if>
		<if test="siteWorkArea !=null and siteWorkArea !=''">
			and work.AREA = #{siteWorkArea}
		</if>
		<if test="orderStatus !=null and orderStatus !=''">
			and workOrder.ODR_STATUS = #{orderStatus} 
		</if>
		<if test="coVatNo !=null and coVatNo !=''">
			and outSourcing.CO_VAT_NO = #{coVatNo} and outSourcing.STATUS in ('OS05', 'OS06', 'OS07')
		</if>	
		<if test="applyDateStart != null and applyDateStart !=''">
			and work.APL_TIME >= #{applyDateStart}
		</if>
		<if test="applyDateEnd != null and applyDateEnd !=''">
			and work.APL_TIME <![CDATA[<=]]> #{applyDateEnd}
		</if>					
			and workOrder.IS_ACTIVE='Y' and workOrder.ODR_STATUS != 'OR01' 
			and work.WORK_TYPE in ('NSR','SH') 
			
		<if test="repDeptList != null and repDeptList.size() > 0">	
			and (workOrder.REP_DEPT in 
			<foreach item="item" index="index" collection="repDeptList"
				open="(" separator="," close=")">
				#{item}
			</foreach>	
			or 
			workOrder.REP_TEAM in 
			<foreach item="item" index="index" collection="repDeptList"
				open="(" separator="," close=")">
				#{item}
			</foreach>)
		</if>
		<if test="todoStatus != null and todoStatus.size() > 0">	
			and workOrder.ODR_STATUS in 
			<foreach item="item" index="index" collection="todoStatus"
				open="(" separator="," close=")">
				#{item}
			</foreach>	
		</if>	
	</where>
		) A
	 </select>  
	 
	 <select id="selectWorkOrderListSgl" resultMap="BaseResultMap">
	 	select A.* from (
	   select DISTINCT
		    workOrder.ORDER_ID, workOrder.ORDER_TYPE, workOrder.WORK_ID, 
		    workOrder.ODR_SEQ, workOrder.PRIORITY, workOrder.ODR_STATUS, 
		    workOrder.REP_DEPT, workOrder.REP_TEAM, workOrder.REP_USER, workOrder.ASSIGN_TIME, 
		    workOrder.PICK_USER, workOrder.PICK_TIME, workOrder.END_USER, 
		    workOrder.END_TIME, workOrder.END_DESC, workOrder.CR_USER, 
		    workOrder.CR_TIME, workOrder.MD_USER, workOrder.MD_TIME, 
		    workOrder.IS_ACTIVE, work.BTS_SITE_ID, work.SITE_NAME,
		    work.SR_ID, work.WORK_TYPE, work.SITE_ID, work.APL_TIME , work.FEQ_ID,
		    feq.FEQ_NAME , work.WORK_STATUS
		    <if test="coVatNo !=null and coVatNo !=''">
		    ,outSourcing.CO_VAT_NO
		    </if>
		from TB_SITE_WORK_ORDER workOrder
		left outer join TB_SITE_WORK work
		on workOrder.work_ID = work.work_ID
		left outer join TB_COM_SITE_FEQ feq
	   	on work.FEQ_ID = feq.FEQ_ID
		<if test="coVatNo !=null and coVatNo !=''">
		left outer join TB_SITE_OUTSOURCING outSourcing
		on workOrder.order_ID = outSourcing.order_ID
		</if>
	  	<where>
		<if test="orderId !=null and orderId !=''">
			and workOrder.ORDER_ID = #{orderId}
		</if>
		<if test="workId !=null and workId !=''">
			and workOrder.work_ID = #{workId}
		</if>
		<if test="orderType !=null and orderType!=''">
			and workOrder.ORDER_TYPE = #{orderType}
		</if>
		<if test="btsSiteId !=null and btsSiteId !=''">
			and work.BTS_SITE_ID = #{btsSiteId}
		</if>
		<if test="siteName !=null and siteName !=''">
			and work.SITE_NAME like '%'+#{siteName}+'%'
		</if>
		<if test="repDept !=null and repDept !=''">
			and (workOrder.REP_DEPT = #{repDept} or workOrder.REP_TEAM = #{repDept})
		</if>

		<if test="repUser !=null and repUser !=''">
			and workOrder.REP_USER = #{repUser}
		</if>
		<if test="orderStatus !=null and orderStatus !=''">
			and workOrder.ODR_STATUS = #{orderStatus} 
		</if>
		<if test="siteWorkCity !=null and siteWorkCity !=''">
			and work.CITY = #{siteWorkCity}
		</if>
		<if test="siteWorkArea !=null and siteWorkArea !=''">
			and work.AREA = #{siteWorkArea}
		</if>
		<if test="coVatNo !=null and coVatNo !=''">
			and outSourcing.CO_VAT_NO = #{coVatNo} and outSourcing.STATUS in ('OS05', 'OS06', 'OS07')
		</if>					
			and workOrder.IS_ACTIVE='Y' and workOrder.ODR_STATUS != 'OR01' 
			and work.WORK_TYPE ='SGL'
			
		<if test="repDeptList != null and repDeptList.size() > 0">	
			and (workOrder.REP_DEPT in 
			<foreach item="item" index="index" collection="repDeptList"
				open="(" separator="," close=")">
				#{item}
			</foreach>	
			or 
			workOrder.REP_TEAM in 
			<foreach item="item" index="index" collection="repDeptList"
				open="(" separator="," close=")">
				#{item}
			</foreach>)
		</if>	
		<if test="siteOrderType !=null and siteOrderType !=''">
			and workOrder.ORDER_TYPE  = #{siteOrderType}
		</if>
		<if test="todoStatus != null and todoStatus.size() > 0">	
			and workOrder.ODR_STATUS in 
			<foreach item="item" index="index" collection="todoStatus"
				open="(" separator="," close=")">
				#{item}
			</foreach>	
		</if>
	</where>
		) A
	 </select> 	 
 
	<update id="updateAssignOrder" >
	    update TB_SITE_WORK_ORDER
	    set ODR_STATUS = 'OR04', 
	    	<if test="maintainTeam != null and maintainTeam !=''">
		    	REP_TEAM = #{maintainTeam}, 
		    </if>
		    <if test="maintainUser != null and maintainUser !=''">
		   	 	REP_USER = #{maintainUser},
		    </if>
		    ASSIGN_USER = #{mdUser ,jdbcType=VARCHAR},
		    ASSIGN_TIME = #{assignTime},
		    MD_USER = #{mdUser ,jdbcType=VARCHAR},
		    MD_TIME = #{mdTime}
	    where ORDER_ID = #{orderId}	   
	</update>  
  
    <update id="updatePickWork" parameterType="java.lang.String" >
      update TB_SITE_WORK_ORDER
      set ODR_STATUS = 'OR05',
      PICK_USER = #{pickWorkName},
      PICK_TIME = GETDATE(),
      MD_USER = #{pickWorkName},
      MD_TIME = GETDATE()
      where ORDER_ID = #{orderId}     
  </update>
  
  <select id="selectSiteWorkOrderByOutSourcing" parameterType="java.lang.String" resultMap="BaseResultMap">
    SELECT 
	A.ORDER_ID,
	OS_ID,
	(SELECT REP_DEPT FROM dbo.TB_SITE_WORK_ORDER WHERE ORDER_ID= A.ORDER_ID) AS REP_DEPT,
	(SELECT ODR_STATUS FROM dbo.TB_SITE_WORK_ORDER WHERE ORDER_ID= A.ORDER_ID) AS ODR_STATUS,
	(SELECT REP_DEPT FROM dbo.TB_SITE_WORK_ORDER WHERE ORDER_ID= A.ORDER_ID) AS REP_TEAM,
	(SELECT DEPT_NAME FROM dbo.TB_ORG_DEPT  WHERE DEPT_ID = 
	    (SELECT REP_DEPT FROM dbo.TB_SITE_WORK_ORDER WHERE ORDER_ID= A.ORDER_ID)
	    ) AS REP_TEAM_NAME,
	APL_DEPT,
	APL_USER,
	(SELECT CHN_NM FROM TB_AUTH_PERSONNEL WHERE PSN_NO = APL_USER) APL_USER_NAME,
	CONVERT(varchar ,OS_TIME,120) OS_TIME,
	CONVERT(varchar ,APL_TIME,120) APL_TIME,
	OS_DESC,
	EQP_TYPE,
	(SELECT EQP_NAME FROM TB_COM_EQP_TYPE WHERE EQP_TYPE_ID = A.EQP_TYPE) AS EQP_TYPE_NAME,
	STATUS,
	CONVERT(varchar ,AP_DATE,120)  AP_DATE,
	CO_VAT_NO,
	ITEM_TYPE,
	A.PO_ID,
	(SELECT PO_YEAR FROM dbo.TB_COM_PO_MAIN WHERE PO_ID= A.PO_ID) AS PO_YEAR
	FROM  
	TB_SITE_OUTSOURCING A
	where
	OS_ID=#{osId} 
	
  </select>
   
   <select id="selectWorkOrderListForBuild" resultMap="BaseResultMap">
	   select A.* from (
	   		select DISTINCT
		    workOrder.ORDER_ID, workOrder.ORDER_TYPE, workOrder.WORK_ID, 
		    workOrder.ODR_SEQ, workOrder.PRIORITY, workOrder.ODR_STATUS, 
		    workOrder.REP_DEPT, workOrder.REP_TEAM, workOrder.REP_USER, workOrder.ASSIGN_TIME, 
		    workOrder.PICK_USER, workOrder.PICK_TIME, workOrder.END_USER, 
		    workOrder.END_TIME, workOrder.END_DESC, workOrder.CR_USER, 
		    workOrder.CR_TIME, workOrder.MD_USER, workOrder.MD_TIME, 
		    workOrder.IS_ACTIVE, work.BTS_SITE_ID, work.SITE_NAME,
		    work.SR_ID, work.WORK_TYPE,work.SITE_ID SITE_ID
		    <if test="coVatNo !=null and coVatNo !=''">
		    ,outSourcing.CO_VAT_NO
		    </if>
		from TB_SITE_WORK_ORDER workOrder
		left outer join TB_SITE_WORK work
		on workOrder.work_ID = work.work_ID
		<if test="coVatNo !=null and coVatNo !=''">
			left outer join TB_SITE_OUTSOURCING outSourcing
			<if test="isVenderQuery != null and isVenderQuery != ''">
				on outSourcing.order_ID like work.WORK_ID + '%'
			</if>
			<if test="isVenderQuery == null or isVenderQuery == ''">
				on workOrder.order_ID = outSourcing.order_ID
			</if>
		</if>
	  	<where>
		<if test="orderId !=null and orderId !=''">
			and workOrder.ORDER_ID = #{orderId}
		</if>
		<if test="workId !=null and workId !=''">
			and workOrder.work_ID = #{workId}
		</if>
		<if test="orderType !=null and orderType!=''">
			and workOrder.ORDER_TYPE = #{orderType}
		</if>
		<if test="btsSiteId !=null and btsSiteId !=''">
			and work.BTS_SITE_ID = #{btsSiteId}
		</if>
		<if test="siteName !=null and siteName !=''">
			and work.SITE_NAME like '%'+#{siteName}+'%'
		</if>
		<if test="repDept !=null and repDept !=''">
			and (workOrder.REP_DEPT = #{repDept} or workOrder.REP_TEAM = #{repDept})
		</if>
		<if test="repUser !=null and repUser !=''">
			and workOrder.REP_USER = #{repUser}
		</if>
		<if test="siteWorkCity !=null and siteWorkCity !=''">
			and work.CITY = #{siteWorkCity}
		</if>
		<if test="siteWorkArea !=null and siteWorkArea !=''">
			and work.AREA = #{siteWorkArea}
		</if>
		<choose>
			<when test="isVenderQuery != null and isVenderQuery !=''">
				and (workOrder.ODR_STATUS = #{orderStatus} or workOrder.ODR_SEQ = '99') 
				and outSourcing.CO_VAT_NO = #{coVatNo} and outSourcing.STATUS in ('OS05', 'OS06', 'OS07')
			</when>
			<otherwise>
				<if test="orderStatus !=null and orderStatus !=''">
					and workOrder.ODR_STATUS = #{orderStatus} 
				</if>
				<if test="coVatNo !=null and coVatNo !=''">
					and outSourcing.CO_VAT_NO = #{coVatNo} and outSourcing.STATUS in ('OS05', 'OS06', 'OS07')
				</if>
			</otherwise>
		</choose>
		<if test="workType !=null and workType!=''">
			and work.WORK_TYPE = #{workType}
		</if>
		<if test="applyDateStart != null and applyDateStart !=''">
			and work.APL_TIME >= #{applyDateStart}
		</if>
		<if test="applyDateEnd != null and applyDateEnd !=''">
			and work.APL_TIME <![CDATA[<=]]> #{applyDateEnd}
		</if>
		<if test="type != null and type !=''">
			and work.WORK_TYPE in ('SB','SBH','SBN') 
		</if>　				
			and workOrder.IS_ACTIVE='Y' and workOrder.ODR_STATUS != 'OR01'
			
		<if test="repDeptList != null and repDeptList.size() > 0">	
			and (workOrder.REP_DEPT in 
			<foreach item="item" index="index" collection="repDeptList"
				open="(" separator="," close=")">
				#{item}
			</foreach>	
			or 
			workOrder.REP_TEAM in 
			<foreach item="item" index="index" collection="repDeptList"
				open="(" separator="," close=")">
				#{item}
			</foreach>)
		</if>	
		<if test="todoStatus != null and todoStatus.size() > 0">	
			and workOrder.ODR_STATUS in 
			<foreach item="item" index="index" collection="todoStatus"
				open="(" separator="," close=")">
				#{item}
			</foreach>	
		</if>	
	</where>
		) A
	 </select>
	 
	 <select id="selectSiteWorkOrderByWorkIdAndIsActive"  resultMap="BaseResultMap">
	    select workOrder.ORDER_ID,orderType.OD_TYPE_NAME OD_TYPE_NAME,workOrder.IS_ACTIVE,
	    dept.DEPT_NAME DEPT_NAME,workOrder.ODR_SEQ,workOrder.ODR_STATUS
		from TB_SITE_WORK_ORDER workOrder
		left outer join TB_SYS_ORDER_TYPE orderType
		on workOrder.ORDER_TYPE = orderType.OD_TYPE_ID
		left outer join  TB_ORG_DEPT dept
		on workOrder.REP_DEPT = dept.DEPT_ID
	    where workOrder.WORK_ID = #{workId} and workOrder.IS_ACTIVE=#{isActive}
	  </select>
	  
	 <select id="selectWorkOrderDept" resultType="string" >
	 	SELECT DISTINCT REP_DEPT from TB_SITE_WORK_ORDER  WHERE REP_DEPT is not null
	 </select>
	 
	 <select id="selectWorkOrderTeam" resultType="string">
	 	SELECT DISTINCT REP_TEAM from TB_SITE_WORK_ORDER WHERE REP_TEAM is not null
	 </select>
	 
	 <select id="selectWorkOrderDeptInUserDept" parameterType="java.util.List" resultMap="BaseResultMap" >
	 	SELECT DISTINCT  rep.REP_DEPT, org.DEPT_NAME FROM (
			select REP_DEPT from TB_SITE_WORK_ORDER
			where REP_DEPT IS NOT NULL
			union 
			select REP_TEAM REP_DEPT from TB_SITE_WORK_ORDER
			where REP_TEAM IS NOT NULL
		) rep
		 JOIN TB_ORG_DEPT org  ON org.DEPT_ID = rep.REP_DEPT
		 <where>
			 <if test="list != null and list.size() > 0">	
				and (rep.REP_DEPT in 
				<foreach item="item" index="index" collection="list"
					open="(" separator="," close=")">
					#{item}
				</foreach>)
			</if>	
		 </where>
	 </select>
</mapper>