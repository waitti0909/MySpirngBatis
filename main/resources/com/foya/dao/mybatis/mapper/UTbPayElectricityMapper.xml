<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foya.dao.mybatis.mapper.UTbPayElectricityMapper">

	<resultMap id="ResultMap" type="com.foya.noms.dto.pay.TbPayElectricityDTO">
		<result column="elec_begin_date" jdbcType="DATE" property="elec_begin_date" />
		<result column="elec_end_date" jdbcType="DATE" property="elec_end_date" />
	    <result column="chrg_mode" jdbcType="VARCHAR" property="chrg_mode" />
	    <result column="electricityDscr" jdbcType="VARCHAR" property="electricityDscr" />
	    <result column="used_degree_day" jdbcType="VARCHAR" property="used_degree_day" />
		<result column="last_used_degree" jdbcType="VARCHAR" property="last_used_degree" />
		<result column="IF_NO_SITE_MAPPING_DSCR" jdbcType="VARCHAR" property="IF_NO_SITE_MAPPING_DSCR" />
	</resultMap>
	 <insert id="insertSelective" parameterType="com.foya.dao.mybatis.model.TbPayElectricity" useGeneratedKeys="true" keyProperty="SEQ_NBR">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Mar 05 15:49:53 CST 2015.
       SET IDENTITY_INSERT  TB_PAY_ELECTRICITY  ON;
    -->
   
    insert into TB_PAY_ELECTRICITY
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="SEQ_NBR != null" >
        SEQ_NBR,
      </if>
      <if test="USE_TYPE != null" >
        USE_TYPE,
      </if>
      <if test="YEAR_MONTH != null" >
        YEAR_MONTH,
      </if>
      <if test="CONTRACT_NO != null" >
        CONTRACT_NO,
      </if>
      <if test="ELECTRICITY_METER_NBR != null" >
        ELECTRICITY_METER_NBR,
      </if>
      <if test="SITE_ID != null" >
        SITE_ID,
      </if>
      <if test="ELECTRICITY_TYPE != null" >
        ELECTRICITY_TYPE,
      </if>
      <if test="TOTAL_USED_DEGREE != null" >
        TOTAL_USED_DEGREE,
      </if>
      <if test="USED_DEGREE != null" >
        USED_DEGREE,
      </if>
      <if test="PAYMENT_REQ_NO != null" >
        PAYMENT_REQ_NO,
      </if>
      <if test="PAYMENT_REQ_ITEM_NO != null" >
        PAYMENT_REQ_ITEM_NO,
      </if>
      <if test="PAYMENT_REQ_AMT != null" >
        PAYMENT_REQ_AMT,
      </if>
      <if test="MEMO != null" >
        MEMO,
      </if>
      <if test="IF_AUTO_DEDUCT != null" >
        IF_AUTO_DEDUCT,
      </if>
      <if test="IF_NO_SITE_MAPPING != null" >
        IF_NO_SITE_MAPPING,
      </if>
      <if test="PAYMENT_REQ_BEGIN_DATE != null" >
        PAYMENT_REQ_BEGIN_DATE,
      </if>
      <if test="PAYMENT_REQ_END_DATE != null" >
        PAYMENT_REQ_END_DATE,
      </if>
      <if test="IMP_FILE_SEQ_NBR != null" >
        IMP_FILE_SEQ_NBR,
      </if>
      <if test="CR_USER != null" >
        CR_USER,
      </if>
      <if test="CR_TIME != null" >
        CR_TIME,
      </if>
      <if test="MD_USER != null" >
        MD_USER,
      </if>
      <if test="MD_TIME != null" >
        MD_TIME,
      </if>
      <if test="SETTING_FEE != null" >
        SETTING_FEE,
      </if>
      <if test="TRANSACTION_FEE != null" >
        TRANSACTION_FEE,
      </if>
      <if test="LINE_NAME != null" >
        LINE_NAME,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="SEQ_NBR != null" >
        #{SEQ_NBR,jdbcType=BIGINT},
      </if>
      <if test="USE_TYPE != null" >
        #{USE_TYPE,jdbcType=CHAR},
      </if>
      <if test="YEAR_MONTH != null" >
        #{YEAR_MONTH,jdbcType=VARCHAR},
      </if>
      <if test="CONTRACT_NO != null" >
        #{CONTRACT_NO,jdbcType=VARCHAR},
      </if>
      <if test="ELECTRICITY_METER_NBR != null" >
        #{ELECTRICITY_METER_NBR,jdbcType=VARCHAR},
      </if>
      <if test="SITE_ID != null" >
        #{SITE_ID,jdbcType=VARCHAR},
      </if>
      <if test="ELECTRICITY_TYPE != null" >
        #{ELECTRICITY_TYPE,jdbcType=VARCHAR},
      </if>
      <if test="TOTAL_USED_DEGREE != null" >
        #{TOTAL_USED_DEGREE,jdbcType=DECIMAL},
      </if>
      <if test="USED_DEGREE != null" >
        #{USED_DEGREE,jdbcType=DECIMAL},
      </if>
      <if test="PAYMENT_REQ_NO != null" >
        #{PAYMENT_REQ_NO,jdbcType=BIGINT},
      </if>
      <if test="PAYMENT_REQ_ITEM_NO != null" >
        #{PAYMENT_REQ_ITEM_NO,jdbcType=SMALLINT},
      </if>
      <if test="PAYMENT_REQ_AMT != null" >
        #{PAYMENT_REQ_AMT,jdbcType=DECIMAL},
      </if>
      <if test="MEMO != null" >
        #{MEMO,jdbcType=VARCHAR},
      </if>
      <if test="IF_AUTO_DEDUCT != null" >
        #{IF_AUTO_DEDUCT,jdbcType=CHAR},
      </if>
      <if test="IF_NO_SITE_MAPPING != null" >
        #{IF_NO_SITE_MAPPING,jdbcType=CHAR},
      </if>
      <if test="PAYMENT_REQ_BEGIN_DATE != null" >
        #{PAYMENT_REQ_BEGIN_DATE,jdbcType=TIMESTAMP},
      </if>
      <if test="PAYMENT_REQ_END_DATE != null" >
        #{PAYMENT_REQ_END_DATE,jdbcType=TIMESTAMP},
      </if>
      <if test="IMP_FILE_SEQ_NBR != null" >
        #{IMP_FILE_SEQ_NBR,jdbcType=BIGINT},
      </if>
      <if test="CR_USER != null" >
        #{CR_USER,jdbcType=VARCHAR},
      </if>
      <if test="CR_TIME != null" >
        #{CR_TIME,jdbcType=TIMESTAMP},
      </if>
      <if test="MD_USER != null" >
        #{MD_USER,jdbcType=VARCHAR},
      </if>
      <if test="MD_TIME != null" >
        #{MD_TIME,jdbcType=TIMESTAMP},
      </if>
      <if test="SETTING_FEE != null" >
        #{SETTING_FEE,jdbcType=DECIMAL},
      </if>
      <if test="TRANSACTION_FEE != null" >
        #{TRANSACTION_FEE,jdbcType=DECIMAL},
      </if>
      <if test="LINE_NAME != null" >
        #{LINE_NAME,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
	

	<!-- <select id="selectTbPayElectricityByPay002" resultType="com.foya.noms.dto.pay.TbPayElectricityDTO" parameterType="hashmap">
		SELECT C.CASH_REQ_NO cashReqNo,
		       A.CONTRACT_NO,
		       (SELECT LS_NAME
		          FROM TB_LS_MAIN
		         WHERE LS_NO = A.CONTRACT_NO
		           AND LS_STATUS = 1) contractName,
		       A.ELECTRICITY_METER_NBR,
		       A.ELECTRICITY_TYPE,
		       (SELECT LOOKUP_CODE_DESC
		          FROM TB_PAY_LOOKUP_CODE
		         WHERE LOOKUP_CODE = A.ELECTRICITY_TYPE
		           AND LOOKUP_TYPE = 'ELECTRICITY_TYPE') electricityDscr,
		       (SELECT LS_S_DATE
		          FROM TB_LS_MAIN
		         WHERE LS_NO = A.CONTRACT_NO
		           AND LS_STATUS = 1) lsSDate,
		       A.PAYMENT_REQ_BEGIN_DATE,
		       A.PAYMENT_REQ_END_DATE,
		       A.USED_DEGREE,
		       A.PAYMENT_REQ_AMT,
		       A.IF_AUTO_DEDUCT,
		      CASE A.IF_AUTO_DEDUCT
		          WHEN 'Y' THEN
		           '是'
		          WHEN 'N' THEN
		           '否'
		          ELSE
		           ''
		       END ifAutoDeductDscr,
		       A.TOTAL_USED_DEGREE,
		       A.MEMO,
		       A.IF_NO_SITE_MAPPING,
		       CASE A.IF_NO_SITE_MAPPING
		          WHEN 'Y' THEN
		           '無站台對應'
		          WHEN 'N' THEN
		           '有站台對應'
		          ELSE
		           ''
		       END siteMemoDSCR,
		       A.SEQ_NBR,
		       0 used_degree_day,
		       0 last_used_degree
		  FROM TB_PAY_ELECTRICITY A, TB_PAY_PAYMENT_REQUEST B, TB_PAY_CASH_REQUIREMENT C
		 WHERE A.PAYMENT_REQ_NO = B.PAYMENT_REQ_NO
		    AND B.CASH_REQ_NO = C.CASH_REQ_NO
			AND C.DOMAIN = #{domain}
		<if test="appUser!=null and appUser!=''">
			AND C.APP_USER = #{appUser}
		</if>
			AND C.APP_DATE BETWEEN #{appStartDate} AND #{appEndDate}
		<if test="electricityMeterNbr!=null and electricityMeterNbr!=''">
			AND A.ELECTRICITY_METER_NBR LIKE '%'+#{electricityMeterNbr}+'%'
		</if>
		<if test="contractNo!=null and contractNo!=''">
			AND A.CONTRACT_NO LIKE '%'+#{contractNo}+'%'
		</if>
			AND A.ELECTRICITY_TYPE = #{electricityType}
			AND C.PROCESS_TYPE LIKE 'E%'
	</select> -->

<select id="selectTbPayElectricityByPay002" resultType="com.foya.noms.dto.pay.TbPayElectricityDTO" parameterType="hashmap">
		SELECT B.CASH_REQ_NO cashReqNo,
		       A.CONTRACT_NO,
		       (SELECT LS_NAME
		          FROM TB_LS_MAIN
		         WHERE LS_NO = A.CONTRACT_NO
		           AND LS_STATUS = 1) contractName,
		       A.ELECTRICITY_METER_NBR,
		       A.ELECTRICITY_TYPE,
		       (SELECT LOOKUP_CODE_DESC
		          FROM TB_PAY_LOOKUP_CODE
		         WHERE LOOKUP_CODE = A.ELECTRICITY_TYPE
		           AND LOOKUP_TYPE = 'ELECTRICITY_TYPE') electricityDscr,
		       (SELECT LS_S_DATE
		          FROM TB_LS_MAIN
		         WHERE LS_NO = A.CONTRACT_NO
		           AND LS_STATUS = 1) lsSDate,
		       A.PAYMENT_REQ_BEGIN_DATE,
		       A.PAYMENT_REQ_END_DATE,
		       A.USED_DEGREE,
		       A.PAYMENT_REQ_AMT,
		       A.IF_AUTO_DEDUCT,
		      CASE A.IF_AUTO_DEDUCT
		          WHEN 'Y' THEN
		           '是'
		          WHEN 'N' THEN
		           '否'
		          ELSE
		           ''
		       END ifAutoDeductDscr,
		       A.TOTAL_USED_DEGREE,
		       A.MEMO,
		       A.IF_NO_SITE_MAPPING,
		       CASE A.IF_NO_SITE_MAPPING
		          WHEN 'Y' THEN
		           '無站台對應'
		          WHEN 'N' THEN
		           '有站台對應'
		          ELSE
		           ''
		       END siteMemoDSCR,
		       A.SEQ_NBR,
		       0 used_degree_day,
		       0 last_used_degree
		  FROM TB_PAY_ELECTRICITY A 
		  left join TB_PAY_PAYMENT_REQUEST B on  A.PAYMENT_REQ_NO = B.PAYMENT_REQ_NO
		 
		WHERE 
		
		 A.CR_TIME BETWEEN #{appStartDate} AND #{appEndDate}
		
		<if test="appUser!=null and appUser!=''">
			AND A.CR_USER = #{appUser}
		</if>
		<if test="electricityMeterNbr!=null and electricityMeterNbr!=''">
			AND A.ELECTRICITY_METER_NBR LIKE '%'+#{electricityMeterNbr}+'%'
		</if>
		<if test="contractNo!=null and contractNo!=''">
			AND A.CONTRACT_NO LIKE '%'+#{contractNo}+'%'
		</if>
			AND A.ELECTRICITY_TYPE = #{electricityType}
			
	</select>
	
	<select id="selectTbPayElectricityByPay002Dtl" resultType="com.foya.noms.dto.pay.TbPayElectricityDTO" parameterType="hashmap">
		SELECT A.CONTRACT_NO,
		       A.ELECTRICITY_METER_NBR,
		       (SELECT LOOKUP_CODE_DESC
		          FROM TB_PAY_LOOKUP_CODE
		         WHERE LOOKUP_CODE = A.ELECTRICITY_TYPE
		           AND LOOKUP_TYPE = 'ELECTRICITY_TYPE') electricityDscr,
		       0 used_degree_day,
		       0 last_used_degree,
		       A.TOTAL_USED_DEGREE,
		       A.USED_DEGREE,
		       A.MEMO,
		       CASE A.IF_NO_SITE_MAPPING
		          WHEN 'Y' THEN
		           '無站台對應'
		          WHEN 'N' THEN
		           '有站台對應'
		          ELSE
		           ''
		       END siteMemoDSCR
		  FROM TB_PAY_ELECTRICITY A
		WHERE A.CONTRACT_NO = #{contractNo}
		     AND A.ELECTRICITY_METER_NBR = #{electricityMeterNbr}
	   <if test="cashReqNo!=null and cashReqNo!=''">
			AND PAYMENT_REQ_NO IN (SELECT PAYMENT_REQ_NO
                            FROM TB_PAY_PAYMENT_REQUEST
                           WHERE CASH_REQ_NO =  #{cashReqNo})
		</if>	
	</select>
	
	<select id="selectTbPayElectricityByPay011" resultType="com.foya.noms.dto.pay.TbPayElectricityDTO" parameterType="hashmap">
		SELECT C.CASH_REQ_NO cashReqNo,A.CONTRACT_NO,A.ELECTRICITY_METER_NBR,
		(SELECT LS_NAME FROM TB_LS_MAIN WHERE LS_NO = A.CONTRACT_NO AND LS_STATUS = 1) contractName,
        (SELECT LOOKUP_CODE_DESC FROM TB_PAY_LOOKUP_CODE WHERE LOOKUP_CODE = A.ELECTRICITY_TYPE AND LOOKUP_TYPE = 'ELECTRICITY_TYPE') electricityDscr,
       A.PAYMENT_REQ_BEGIN_DATE,A.PAYMENT_REQ_END_DATE,A.TOTAL_USED_DEGREE,A.PAYMENT_REQ_AMT,
       CASE A.USE_TYPE
          WHEN 'E' THEN
           '用電'
          WHEN 'L' THEN
           '專線'
          ELSE
           ''
       END useTypeDscr,
       A.YEAR_MONTH,(SELECT SITE_NAME FROM TB_SITE_MAIN WHERE SITE_ID = A.SITE_ID) siteName,
       A.USED_DEGREE,A.MEMO,
       CASE A.IF_AUTO_DEDUCT
          WHEN 'Y' THEN
           '是'
          WHEN 'N' THEN
           '否'
          ELSE
           ''
       END ifAutoDeductDscr,
      CASE A.IF_NO_SITE_MAPPING
          WHEN 'Y' THEN
           '無站台對應'
          WHEN 'N' THEN
           '有站台對應'
          ELSE
           ''
       END ifNoSiteMappingDscr,
       B.PAYMENT_REQ_NO,C.APP_DATE  appDate
       
       FROM TB_PAY_ELECTRICITY A
       LEFT JOIN TB_PAY_PAYMENT_REQUEST B
       ON A.PAYMENT_REQ_NO = B.PAYMENT_REQ_NO
       LEFT JOIN TB_PAY_CASH_REQUIREMENT C 
       ON B.CASH_REQ_NO = C.CASH_REQ_NO
       LEFT JOIN TB_SITE_MAIN D
       ON A.SITE_ID = D.SITE_ID
       
       WHERE 
        C.STATUS IN ('F','G')
        AND C.CASH_REQ_NO LIKE 'E%'
        AND C.CASH_REQ_NO NOT IN 
       (SELECT H.CASH_REQ_AP_NO 
        FROM TB_PAY_PAYMENT_REQUEST_VOUCHER G, TB_PAY_VOUCHER_CREDIT H 
        WHERE G.SEQ_NBR = H.MST_SEQ_NBR 
        AND H.CASH_REQ_AP_NO=B.CASH_REQ_NO
        AND H.PAYMENT_REQ_NO = A.PAYMENT_REQ_NO
        AND H.PAYMENT_REQ_ITEM_NO = A.PAYMENT_REQ_ITEM_NO)
		<if test="domain!=null and domain!=''">
			AND C.DOMAIN = #{domain}
		</if>	
		<if test="electricityType!=null and electricityType!=''">
			AND A.ELECTRICITY_TYPE = #{electricityType}
		</if>	
		<if test="electricityMeterNbr!=null and electricityMeterNbr!=''">
			AND A.ELECTRICITY_METER_NBR LIKE '%'+#{electricityMeterNbr}+'%'
		</if>
		<if test="paymentReqStartDate !=null and paymentReqStartDate !='' and paymentReqEndDate != null and paymentReqEndDate !=''">
			AND A.PAYMENT_REQ_BEGIN_DATE BETWEEN #{paymentReqStartDate} AND #{paymentReqEndDate}
		</if>
		<if test="paymentReqStartDate !=null and paymentReqStartDate !='' and paymentReqEndDate != null and paymentReqEndDate !=''">
			AND A.PAYMENT_REQ_END_DATE BETWEEN #{paymentReqStartDate} AND #{paymentReqEndDate}
		</if>		 
		<if test="btsSiteId!=null and btsSiteId!=''">
			AND D.BTS_SITE_ID =  #{btsSiteId}
		</if>
	</select>
	
	<!--<select id="selectTbPayElectricityByPay011" resultType="com.foya.noms.dto.pay.TbPayElectricityDTO" parameterType="hashmap">
		SELECT C.CASH_REQ_NO cashReqNo,A.CONTRACT_NO,A.ELECTRICITY_METER_NBR,
		(SELECT LS_NAME FROM TB_LS_MAIN WHERE LS_NO = A.CONTRACT_NO AND LS_STATUS = 1) contractName,
        (SELECT LOOKUP_CODE_DESC FROM TB_PAY_LOOKUP_CODE WHERE LOOKUP_CODE = A.ELECTRICITY_TYPE AND LOOKUP_TYPE = 'ELECTRICITY_TYPE') electricityDscr,
       A.PAYMENT_REQ_BEGIN_DATE,A.PAYMENT_REQ_END_DATE,A.TOTAL_USED_DEGREE,A.PAYMENT_REQ_AMT,
       CASE A.USE_TYPE
          WHEN 'E' THEN
           '用電'
          WHEN 'L' THEN
           '專線'
          ELSE
           ''
       END useTypeDscr,
       A.YEAR_MONTH,(SELECT SITE_NAME FROM TB_SITE_MAIN WHERE SITE_ID = A.SITE_ID) siteName,
       A.USED_DEGREE,A.MEMO,
       CASE A.IF_AUTO_DEDUCT
          WHEN 'Y' THEN
           '是'
          WHEN 'N' THEN
           '否'
          ELSE
           ''
       END ifAutoDeductDscr,
      CASE A.IF_NO_SITE_MAPPING
          WHEN 'Y' THEN
           '無站台對應'
          WHEN 'N' THEN
           '有站台對應'
          ELSE
           ''
       END ifNoSiteMappingDscr,
       B.PAYMENT_REQ_NO,C.APP_DATE  appDate
       FROM TB_PAY_ELECTRICITY A, TB_PAY_PAYMENT_REQUEST B, TB_PAY_CASH_REQUIREMENT C , TB_SITE_MAIN D
       WHERE A.PAYMENT_REQ_NO = B.PAYMENT_REQ_NO
       AND B.CASH_REQ_NO = C.CASH_REQ_NO
       AND C.CASH_REQ_NO NOT IN 
       (SELECT G.VOUCHER_NO 
        FROM TB_PAY_PAYMENT_REQUEST_VOUCHER G, TB_PAY_VOUCHER_CREDIT H 
        WHERE G.SEQ_NBR = H.MST_SEQ_NBR 
        AND H.CASH_REQ_AP_NO = C.CASH_REQ_NO
        AND H.PAYMENT_REQ_NO = B.PAYMENT_REQ_NO)
		<if test="domain!=null and domain!=''">
			AND C.DOMAIN = #{domain}
		</if>	
		<if test="electricityType!=null and electricityType!=''">
			AND A.ELECTRICITY_TYPE = #{electricityType}
		</if>	
		<if test="electricityMeterNbr!=null and electricityMeterNbr!=''">
			AND A.ELECTRICITY_METER_NBR LIKE '%'+#{electricityMeterNbr}+'%'
		</if>
		<if test="paymentReqStartDate !=null and paymentReqStartDate !='' and paymentReqEndDate != null and paymentReqEndDate !=''">
			AND A.PAYMENT_REQ_BEGIN_DATE BETWEEN #{paymentReqStartDate} AND #{paymentReqEndDate}
		</if>
		<if test="paymentReqStartDate !=null and paymentReqStartDate !='' and paymentReqEndDate != null and paymentReqEndDate !=''">
			AND A.PAYMENT_REQ_END_DATE BETWEEN #{paymentReqStartDate} AND #{paymentReqEndDate}
		</if>
		AND C.STATUS IN ('F','G')
		AND C.CASH_REQ_NO LIKE 'E%'
		AND D.SITE_ID = A.SITE_ID
		<if test="btsSiteId!=null and btsSiteId!=''">
			AND D.BTS_SITE_ID =  #{btsSiteId}
		</if>
	</select>-->
	
	<select id="selectDtlForPAY003Table2" resultMap="ResultMap" parameterType="hashmap">
		select 
		A.contract_no,
		A.ELECTRICITY_METER_NBR,
		(select lookup_code_desc from TB_PAY_LOOKUP_CODE where lookup_type='electricity_type' and lookup_code= A.electricity_type) electricityDscr,
		(select chrg_mode = case e.ELEC_MODE when 'C' then e.CHRG_MODE  when 'D' then (select r.NORMAL_PRICE from TB_LS_ELEC_RANGE r where e.chrg_mode
         between r.begin_range and r.end_range and getDate() between r.eff_date and r.end_date) else 0 end
         from TB_LS_LOC_ELEC e where ls_no=#{contractNo} and energy_meter=A.ELECTRICITY_METER_NBR and getDate() between elec_begin_date and elec_end_date) chrg_mode,
		(select elec_begin_date from TB_LS_LOC_ELEC where ls_no=#{contractNo} and energy_meter= A.ELECTRICITY_METER_NBR) elec_begin_date,
		(select elec_end_date from TB_LS_LOC_ELEC where ls_no=#{contractNo} and energy_meter= A.ELECTRICITY_METER_NBR) elec_end_date,
		A.PAYMENT_REQ_BEGIN_DATE,
		A.PAYMENT_REQ_END_DATE,
		0 used_degree_day,
		0 last_used_degree,
		A.total_used_degree,
		A.used_degree,
		A.MEMO,
		A.PAYMENT_REQ_AMT,
		IF_NO_SITE_MAPPING = CASE A.IF_NO_SITE_MAPPING 
		WHEN 'Y' THEN '無站台對應'
		ELSE '有站台對應' END
		from TB_PAY_ELECTRICITY A
		where A.use_type='E'
		and A.contract_no=#{contractNo} 
		and A.Year_month=#{yearMonth} 
		and A.payment_req_no= #{paymentReqNo} 
	</select>
	
	<select id="selectDtl4PAY003ATb2" resultMap="ResultMap" parameterType="hashmap">
	select 
	A.SEQ_NBR,
	A.IMP_FILE_SEQ_NBR,
	A.contract_no,
		A.ELECTRICITY_METER_NBR,
		A.ELECTRICITY_TYPE,
		(select lookup_code_desc from TB_PAY_LOOKUP_CODE where lookup_type='electricity_type' and LOOKUP_CODE = a.ELECTRICITY_TYPE) electricityDscr,
		(select chrg_mode = case e.ELEC_MODE when 'C' then e.CHRG_MODE  when 'D' then (select r.NORMAL_PRICE from TB_LS_ELEC_RANGE r where e.chrg_mode
		 between r.begin_range and r.end_range and getDate() between r.eff_date and r.end_date) else 0 end
		 from TB_LS_LOC_ELEC e where ls_no=A.contract_no and energy_meter=A.ELECTRICITY_METER_NBR and getDate() between elec_begin_date and elec_end_date) chrg_mode,
		(select elec_begin_date from TB_LS_LOC_ELEC where ls_no=A.contract_no and energy_meter= A.ELECTRICITY_METER_NBR) elec_begin_date,
		(select elec_end_date from TB_LS_LOC_ELEC where ls_no=A.contract_no and energy_meter= A.ELECTRICITY_METER_NBR) elec_end_date,
		A.PAYMENT_REQ_BEGIN_DATE,
		A.PAYMENT_REQ_END_DATE,
		0 used_degree_day,
		0 last_used_degree,
		A.total_used_degree,
		A.used_degree,
		A.MEMO,
		A.PAYMENT_REQ_AMT,
		A.IF_NO_SITE_MAPPING ,
		A.IF_AUTO_DEDUCT,
		IF_NO_SITE_MAPPING_DSCR = CASE A.IF_NO_SITE_MAPPING 
		WHEN 'Y' THEN '無站台對應'
		ELSE '有站台對應' END
	from TB_PAY_ELECTRICITY A
	where A.use_type='E'  
		and contract_no=#{contractNo} 
		and A.payment_req_no is null 
		and A.payment_req_item_no is null ;
	</select>
	
	<!-- 取得用電度數、用電天數、上期度數  -->
	<select id="PAY_USED_DEGREE_M_DAY" statementType="CALLABLE" parameterType="map">
		{call PAY_USED_DEGREE_M_DAY(
		#{PI_contractNo,mode=IN,jdbcType=NVARCHAR},
		#{PI_electricity_Meter_Nbr,mode=IN,jdbcType=NVARCHAR},
		#{PO_DEGREE,mode=OUT,jdbcType=DECIMAL},
		#{PO_m_day,mode=OUT,jdbcType=DECIMAL},
		#{PO_LAST_DEGREE,mode=OUT,jdbcType=DECIMAL})}
	</select>
	
</mapper>