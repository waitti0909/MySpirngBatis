<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foya.dao.mybatis.mapper.UTbPayCashRequirementMapper">
	<resultMap id="ResultMap" type="com.foya.noms.dto.pay.TbPayCashRequirementDTO">
	    <!--
	      WARNING - @mbggenerated
	      This element is automatically generated by MyBatis Generator, do not modify.
	      This element was generated on Tue Jan 27 18:23:50 CST 2015.
	    -->
	    <result column="PR_CNT" jdbcType="BIGINT" property="PR_CNT" />
	    <result column="VOUCHER_CNT" jdbcType="BIGINT" property="VOUCHER_CNT" />
	    <result column="sumTaxExclusiveTotalAmt" jdbcType="DECIMAL" property="sumTaxExclusiveTotalAmt" />
	    <result column="S_TAX_EXCLUSIVE_AMT" jdbcType="DECIMAL" property="S_TAX_EXCLUSIVE_AMT" />
	    <result column="S_TAX_EXCLUSIVE_TOTAL_AMT" jdbcType="DECIMAL" property="S_TAX_EXCLUSIVE_TOTAL_AMT" />
	    <result column="S_TOTAL_BUSINESS_TAX" jdbcType="DECIMAL" property="S_TOTAL_BUSINESS_TAX" />
	    <result column="S_TOTAL_INCOME_TAX" jdbcType="DECIMAL" property="S_TOTAL_INCOME_TAX" />
	    <result column="S_TOTAL_NHI_AMT" jdbcType="DECIMAL" property="S_TOTAL_NHI_AMT" />
	    <result column="S_EXCLUSIVE_BUSINESS_TAX" jdbcType="DECIMAL" property="S_EXCLUSIVE_BUSINESS_TAX" />
	    <result column="AMOUNT_DUE" jdbcType="DECIMAL" property="AMOUNT_DUE" />
	    <result column="APP_USER_DSCR" jdbcType="VARCHAR" property="APP_USER_DSCR" />
	    <result column="statusDscr" jdbcType="VARCHAR" property="statusDscr" />
	    <result column="ACCOUNT_APPROVAL_USER_DSCR" jdbcType="VARCHAR" property="ACCOUNT_APPROVAL_USER_DSCR" />
	    <result column="PAYMENT_PERIOD" jdbcType="VARCHAR" property="PAYMENT_PERIOD" />
    </resultMap>
    <resultMap id="paymentMap" type="com.foya.noms.dto.pay.TbPayPaymentDTO">
    </resultMap>
    
    <select id="selectTbPayCashRequirementPay007ByType" resultMap="ResultMap" parameterType="hashmap">
		SELECT COUNT(C.PAYMENT_REQ_NO) PR_CNT,
		       COUNT(E.MST_SEQ_NBR) VOUCHER_CNT,
		       SUM(D.TAX_EXCLUSIVE_TOTAL_AMT) S_TAX_EXCLUSIVE_TOTAL_AMT,
		       SUM(D.TOTAL_BUSINESS_TAX) S_TOTAL_BUSINESS_TAX,
		       SUM(D.TOTAL_INCOME_TAX) S_TOTAL_INCOME_TAX,
		       SUM(D.TOTAL_NHI_AMT) S_TOTAL_NHI_AMT,
		       SUM(D.TAX_EXCLUSIVE_TOTAL_AMT + D.TOTAL_BUSINESS_TAX - D.TOTAL_INCOME_TAX - D.TOTAL_NHI_AMT) AMOUNT_DUE,
		       isnull( (Select SUM (BB.tax_exclusive_amt + BB.business_tax) 
		       from TB_PAY_PAYMENT_REQUEST AA,TB_PAY_PAYMENT_REQUEST_DTL BB
		       where AA.payment_req_no=BB.payment_req_no and AA.cash_req_no=A.cash_req_no and (BB.payment_request_item like 'REP%' or BB.payment_request_item like 'ELP%')
		       ),0)S_FORFEIT_AMT,
		       A.CASH_REQ_NO,
		       A.APP_USER,
		       A.APP_DATE,
		       A.ACCOUNT_APPROVAL_USER,
		       A.ACCOUNT_APPROVAL_DATE,
		       A.REJECT_REASON,
		       A.REJECT_MEMO,
		       (SELECT CHN_NM FROM TB_AUTH_PERSONNEL WHERE PSN_NO=A.APP_USER) APP_USER_DSCR,
		       (SELECT CHN_NM FROM TB_AUTH_PERSONNEL WHERE PSN_NO=A.ACCOUNT_APPROVAL_USER) ACCOUNT_APPROVAL_USER_DSCR,
		       A.PROCESS_TYPE		       
		  FROM TB_PAY_CASH_REQUIREMENT A
		  LEFT JOIN TB_PAY_PAYMENT_REQUEST B
		  ON A.CASH_REQ_NO = B.CASH_REQ_NO
		  LEFT JOIN TB_PAY_PAYMENT_REQUEST_DTL C    
		  ON B.PAYMENT_REQ_NO = C.PAYMENT_REQ_NO
		  LEFT JOIN TB_PAY_PAYMENT D
		  ON C.PAYMENT_REQ_NO = D.PAYMENT_REQ_NO AND C.ITEM_NO = D.PAYMENT_REQ_ITEM_NO
		  LEFT JOIN TB_PAY_VOUCHER_CREDIT E
		  ON E.PAYMENT_REQ_NO = C.PAYMENT_REQ_NO AND E.PAYMENT_REQ_ITEM_NO = C.ITEM_NO
		 WHERE 
		   A.STATUS = 'C'
		<if test="domain!=null and domain!=''">
			AND A.DOMAIN = #{domain}
		</if>	
		<if test="processType!=null and processType!=''">
			AND A.PROCESS_TYPE LIKE #{processType}
		</if>	
		<if test="appUser!=null and appUser!=''">
			AND A.APP_USER = #{appUser}
		</if>	
		<if test="appStartDate !=null and appStartDate !='' and appEndDate != null and appEndDate !=''">
			AND convert(date,A.APP_DATE) BETWEEN convert(date,#{appStartDate}) AND convert(date,#{appEndDate})
		</if>
		<if test="yearMonth!=null and yearMonth!=''">
			AND A.YEAR_MONTH = #{yearMonth}
		</if>
		<if test="cashReqNo!=null and cashReqNo!=''">
			AND A.CASH_REQ_NO LIKE '%'+#{cashReqNo}+'%'
		</if>			 
		   GROUP BY A.CASH_REQ_NO,A.APP_USER,A.APP_DATE,A.ACCOUNT_APPROVAL_USER,A.ACCOUNT_APPROVAL_DATE,A.REJECT_REASON,A.REJECT_MEMO,A.PROCESS_TYPE
	</select>
	
	<select id="selectTbPayCashRequirementPay007" resultMap="ResultMap" parameterType="hashmap">
		SELECT COUNT(C.PAYMENT_REQ_NO) PR_CNT,
		       COUNT(E.MST_SEQ_NBR) VOUCHER_CNT,
		       SUM(D.TAX_EXCLUSIVE_TOTAL_AMT) S_TAX_EXCLUSIVE_TOTAL_AMT,
		       SUM(D.TOTAL_BUSINESS_TAX) S_TOTAL_BUSINESS_TAX,
		       SUM(D.TOTAL_INCOME_TAX) S_TOTAL_INCOME_TAX,
		       SUM(D.TOTAL_NHI_AMT) S_TOTAL_NHI_AMT,
		       SUM(D.TAX_EXCLUSIVE_TOTAL_AMT + D.TOTAL_BUSINESS_TAX - D.TOTAL_INCOME_TAX - D.TOTAL_NHI_AMT) AMOUNT_DUE,
		       isnull( (Select SUM (BB.tax_exclusive_amt + BB.business_tax) 
		       from TB_PAY_PAYMENT_REQUEST AA,TB_PAY_PAYMENT_REQUEST_DTL BB
		       where AA.payment_req_no=BB.payment_req_no and AA.cash_req_no=A.cash_req_no and (BB.payment_request_item like 'REP%' or BB.payment_request_item like 'ELP%')
		       ),0)S_FORFEIT_AMT,
		       A.CASH_REQ_NO,
		       A.APP_USER,
		       A.APP_DATE,
		       A.ACCOUNT_APPROVAL_USER,
		       A.ACCOUNT_APPROVAL_DATE,
		       A.REJECT_REASON,
		       A.REJECT_MEMO,
		       (SELECT CHN_NM FROM TB_AUTH_PERSONNEL WHERE PSN_NO=A.APP_USER) APP_USER_DSCR,
		       (SELECT CHN_NM FROM TB_AUTH_PERSONNEL WHERE PSN_NO=A.ACCOUNT_APPROVAL_USER) ACCOUNT_APPROVAL_USER_DSCR,
		       A.PROCESS_TYPE
		  FROM TB_PAY_CHECK_DISREGARD F
		  LEFT JOIN  TB_PAY_CASH_REQUIREMENT A
		  ON F.CASH_REQ_NO = A.CASH_REQ_NO
		  LEFT JOIN TB_PAY_PAYMENT_REQUEST B
		  ON A.CASH_REQ_NO = B.CASH_REQ_NO
		  LEFT JOIN TB_PAY_PAYMENT_REQUEST_DTL C
		  ON B.PAYMENT_REQ_NO = C.PAYMENT_REQ_NO AND F.PAYMENT_REQ_NO = C.PAYMENT_REQ_NO AND F.PAYMENT_REQ_ITEM_NO = C.ITEM_NO
		  LEFT JOIN TB_PAY_PAYMENT D
		  ON C.PAYMENT_REQ_NO = D.PAYMENT_REQ_NO AND C.ITEM_NO=D.PAYMENT_REQ_ITEM_NO AND F.PAYMENT_SEQ_NBR=D.SEQ_NBR
		  LEFT JOIN TB_PAY_VOUCHER_CREDIT E
		  ON  E.PAYMENT_REQ_NO = C.PAYMENT_REQ_NO  AND E.PAYMENT_REQ_ITEM_NO = C.ITEM_NO 
		 WHERE 
		   F.STATUS = 'C'		   
		<if test="domain!=null and domain!=''">
			AND F.DOMAIN = #{domain}
		</if>	
		<if test="appUser!=null and appUser!=''">
			AND F.APP_USER = #{appUser}
		</if>	
		<if test="appStartDate !=null and appStartDate !='' and appEndDate != null and appEndDate !=''">
			AND convert(date,F.APP_DATE) BETWEEN convert(date,#{appStartDate}) AND convert(date,#{appEndDate})
		</if>		
		<if test="yearMonth!=null and yearMonth!=''">
			AND A.YEAR_MONTH = #{yearMonth}
		</if>
		<if test="cashReqNo!=null and cashReqNo!=''">
			AND A.CASH_REQ_NO LIKE '%'+#{cashReqNo}+'%'
		</if>	
		GROUP BY A.CASH_REQ_NO,A.APP_USER,A.APP_DATE,A.ACCOUNT_APPROVAL_USER,A.ACCOUNT_APPROVAL_DATE,A.REJECT_REASON,A.REJECT_MEMO,A.PROCESS_TYPE
	</select>
	<!--<select id="selectTbPayCashRequirementPay007ByType" resultMap="ResultMap" parameterType="hashmap">
		SELECT COUNT(C.PAYMENT_REQ_NO) PR_CNT,
		       COUNT(E.MST_SEQ_NBR) VOUCHER_CNT,
		       SUM(D.TAX_EXCLUSIVE_TOTAL_AMT) S_TAX_EXCLUSIVE_TOTAL_AMT,
		       SUM(D.TOTAL_BUSINESS_TAX) S_TOTAL_BUSINESS_TAX,
		       SUM(D.TOTAL_INCOME_TAX) S_TOTAL_INCOME_TAX,
		       SUM(D.TOTAL_NHI_AMT) S_TOTAL_NHI_AMT,
		       SUM(D.TAX_EXCLUSIVE_TOTAL_AMT + D.TOTAL_BUSINESS_TAX - D.TOTAL_INCOME_TAX - D.TOTAL_NHI_AMT) AMOUNT_DUE,
		       SUM(C.TAX_EXCLUSIVE_AMT + C.BUSINESS_TAX) S_FORFEIT_AMT,
		       A.CASH_REQ_NO,
		       A.APP_USER,
		       A.APP_DATE,
		       A.ACCOUNT_APPROVAL_USER,
		       A.ACCOUNT_APPROVAL_DATE,
		       A.REJECT_REASON,
		       A.REJECT_MEMO,
		       A.PAYMENT_PERIOD,
		       (SELECT CHN_NM FROM TB_AUTH_PERSONNEL WHERE PSN_NO=A.APP_USER) APP_USER_DSCR,
		       (SELECT CHN_NM FROM TB_AUTH_PERSONNEL WHERE PSN_NO=A.ACCOUNT_APPROVAL_USER) ACCOUNT_APPROVAL_USER_DSCR,
		       A.PROCESS_TYPE
		  FROM TB_PAY_CASH_REQUIREMENT A,
		       TB_PAY_PAYMENT_REQUEST B,
		       TB_PAY_PAYMENT_REQUEST_DTL C,
		       TB_PAY_PAYMENT D,
		       TB_PAY_VOUCHER_CREDIT E
		 WHERE A.CASH_REQ_NO = B.CASH_REQ_NO
		   AND B.PAYMENT_REQ_NO = C.PAYMENT_REQ_NO
		   AND C.PAYMENT_REQ_NO = D.PAYMENT_REQ_NO
		   AND C.ITEM_NO = D.PAYMENT_REQ_ITEM_NO
		   AND E.PAYMENT_REQ_NO = C.PAYMENT_REQ_NO
		   AND E.PAYMENT_REQ_ITEM_NO = C.ITEM_NO
		   AND C.PAYMENT_REQUEST_ITEM IN (SELECT EXP_ITEM FROM TB_PAY_PAYMENT_ITEM WHERE EXP_ITEM_DESC LIKE '%滯納金%' AND PAYMENT_REQ_ITEM IN ('REP', 'ELP'))
		<if test="domain!=null and domain!=''">
			AND A.DOMAIN = #{domain}
		</if>	
		<if test="processType!=null and processType!=''">
			AND A.PROCESS_TYPE LIKE #{processType}
		</if>	
		<if test="appUser!=null and appUser!=''">
			AND A.APP_USER = #{appUser}
		</if>	
		<if test="appStartDate !=null and appStartDate !='' and appEndDate != null and appEndDate !=''">
			AND convert(date,A.APP_DATE) BETWEEN convert(date,#{appStartDate}) AND convert(date,#{appEndDate})
		</if>
		<if test="yearMonth!=null and yearMonth!=''">
			AND A.YEAR_MONTH = #{yearMonth}
		</if>
		<if test="cashReqNo!=null and cashReqNo!=''">
			AND A.CASH_REQ_NO LIKE '%'+#{cashReqNo}+'%'
		</if>	
		   AND A.STATUS = 'C'
		   GROUP BY A.CASH_REQ_NO,A.APP_USER,A.APP_DATE,A.ACCOUNT_APPROVAL_USER,A.ACCOUNT_APPROVAL_DATE,A.REJECT_REASON,A.REJECT_MEMO,A.PAYMENT_PERIOD,A.PROCESS_TYPE
	</select>
	
	<select id="selectTbPayCashRequirementPay007" resultMap="ResultMap" parameterType="hashmap">
		SELECT COUNT(C.PAYMENT_REQ_NO) PR_CNT,
		       COUNT(E.MST_SEQ_NBR) VOUCHER_CNT,
		       SUM(D.TAX_EXCLUSIVE_TOTAL_AMT) S_TAX_EXCLUSIVE_TOTAL_AMT,
		       SUM(D.TOTAL_BUSINESS_TAX) S_TOTAL_BUSINESS_TAX,
		       SUM(D.TOTAL_INCOME_TAX) S_TOTAL_INCOME_TAX,
		       SUM(D.TOTAL_NHI_AMT) S_TOTAL_NHI_AMT,
		       SUM(D.TAX_EXCLUSIVE_TOTAL_AMT + D.TOTAL_BUSINESS_TAX - D.TOTAL_INCOME_TAX - D.TOTAL_NHI_AMT) AMOUNT_DUE,
		       SUM(C.TAX_EXCLUSIVE_AMT + C.BUSINESS_TAX) S_FORFEIT_AMT,
		       A.CASH_REQ_NO,
		       A.APP_USER,
		       A.APP_DATE,
		       A.ACCOUNT_APPROVAL_USER,
		       A.ACCOUNT_APPROVAL_DATE,
		       A.REJECT_REASON,
		       A.REJECT_MEMO,
		       (SELECT CHN_NM FROM TB_AUTH_PERSONNEL WHERE PSN_NO=A.APP_USER) APP_USER_DSCR,
		       (SELECT CHN_NM FROM TB_AUTH_PERSONNEL WHERE PSN_NO=A.ACCOUNT_APPROVAL_USER) ACCOUNT_APPROVAL_USER_DSCR,
		       A.PROCESS_TYPE
		  FROM TB_PAY_CASH_REQUIREMENT A,
		       TB_PAY_PAYMENT_REQUEST B,
		       TB_PAY_PAYMENT_REQUEST_DTL C,
		       TB_PAY_PAYMENT D,
		       TB_PAY_VOUCHER_CREDIT E,
		       TB_PAY_CHECK_DISREGARD F
		 WHERE A.CASH_REQ_NO = B.CASH_REQ_NO
		   AND B.PAYMENT_REQ_NO = C.PAYMENT_REQ_NO
		   AND C.PAYMENT_REQ_NO = D.PAYMENT_REQ_NO
		   AND C.ITEM_NO=D.PAYMENT_REQ_ITEM_NO
		   AND E.PAYMENT_REQ_NO = C.PAYMENT_REQ_NO
		   AND E.PAYMENT_REQ_ITEM_NO = C.ITEM_NO
		   AND F.CASH_REQ_NO = A.CASH_REQ_NO
		   AND F.PAYMENT_REQ_NO = C.PAYMENT_REQ_NO
		   AND F.PAYMENT_REQ_ITEM_NO = C.ITEM_NO
		   AND F.PAYMENT_SEQ_NBR=D.SEQ_NBR
		   AND C.PAYMENT_REQUEST_ITEM IN (SELECT EXP_ITEM FROM TB_PAY_PAYMENT_ITEM WHERE EXP_ITEM_DESC LIKE '%滯納金%' AND PAYMENT_REQ_ITEM IN ('REP', 'ELP'))
		<if test="domain!=null and domain!=''">
			AND F.DOMAIN = #{domain}
		</if>	
		<if test="appUser!=null and appUser!=''">
			AND F.APP_USER = #{appUser}
		</if>	
		<if test="appStartDate !=null and appStartDate !='' and appEndDate != null and appEndDate !=''">
			AND convert(date,F.APP_DATE) BETWEEN convert(date,#{appStartDate}) AND convert(date,#{appEndDate})
		</if>
		 AND F.STATUS = 'C'
		<if test="yearMonth!=null and yearMonth!=''">
			AND A.YEAR_MONTH = #{yearMonth}
		</if>
		<if test="cashReqNo!=null and cashReqNo!=''">
			AND A.CASH_REQ_NO LIKE '%'+#{cashReqNo}+'%'
		</if>	
		GROUP BY A.CASH_REQ_NO,A.APP_USER,A.APP_DATE,A.ACCOUNT_APPROVAL_USER,A.ACCOUNT_APPROVAL_DATE,A.REJECT_REASON,A.REJECT_MEMO,A.PROCESS_TYPE
	</select>-->
	
	<select id="searchWithPayment" resultMap="paymentMap" parameterType="hashmap">
	SELECT C.*,F.PAYMENT_REQUEST_ITEM,(SELECT LOOKUP_CODE_DESC FROM TB_PAY_LOOKUP_CODE WHERE LOOKUP_TYPE='PR_ITEM' AND LOOKUP_CODE=F.PAYMENT_REQUEST_ITEM) dtlItemDesc,
	 D.VOUCHER_TYPE,(SELECT LOOKUP_CODE_DESC FROM TB_PAY_LOOKUP_CODE WHERE LOOKUP_TYPE='VOUCHER_TYPE' AND LOOKUP_CODE=D.VOUCHER_TYPE) voucherDesc,
	 D.VOUCHER_NBR,D.VOUCHER_DATE,D.VAT_NUMBER,A.CASH_REQ_NO cashReqNo,D.SEQ_NBR voucherSeqNbr,
	 (C.TAX_EXCLUSIVE_TOTAL_AMT+C.TOTAL_BUSINESS_TAX-C.TOTAL_INCOME_TAX-C.TOTAL_NHI_AMT) TOTALAMT,
	 (SELECT LOOKUP_CODE_DESC FROM TB_PAY_LOOKUP_CODE WHERE LOOKUP_TYPE='PAYMENT_METHOD' AND LOOKUP_CODE=C.PAYMENT_METHOD) paymentDesc,
	 (SELECT UNIT_NAME FROM TB_LS_COLLECT_UNIT WHERE UNIT_CODE=C.BANK_CODE) bankCodeDesc,A.YEAR_MONTH yearMonth,
	 (SELECT SUB_NAME FROM TB_LS_COLLECT_UNIT_SUB WHERE SUB_UNIT_CODE=C.BANK_BRANCH_CODE AND UNIT_CODE=C.BANK_CODE) branchCodeDesc,'Y' chechShare
	FROM TB_PAY_CASH_REQUIREMENT A,
	TB_PAY_PAYMENT_REQUEST B, TB_PAY_PAYMENT C, TB_PAY_PAYMENT_REQUEST_VOUCHER D,
	TB_PAY_VOUCHER_CREDIT E,
	TB_PAY_PAYMENT_REQUEST_DTL F
	WHERE A.CASH_REQ_NO =#{cashReqNo}
	and A.CASH_REQ_NO=B.CASH_REQ_NO AND
	B.PAYMENT_REQ_NO =F.PAYMENT_REQ_NO AND
	F.PAYMENT_REQ_NO =C.PAYMENT_REQ_NO AND
	F.ITEM_NO = C.PAYMENT_REQ_ITEM_NO AND
	D.SEQ_NBR=E.MST_SEQ_NBR AND
	F.PAYMENT_REQ_NO =E.PAYMENT_REQ_NO AND
	F.ITEM_NO= E.PAYMENT_REQ_ITEM_NO
	</select>	
	


	
	<select id="searchForPay003" resultMap="ResultMap" parameterType="hashmap">
	SELECT  COUNT(B.PAYMENT_REQ_NO) PR_CNT,
			COUNT(F.SEQ_NBR) VOUCHER_CNT,
			SUM(D.TAX_EXCLUSIVE_TOTAL_AMT) sumTaxExclusiveTotalAmt,
			SUM(D.TOTAL_BUSINESS_TAX) S_TOTAL_BUSINESS_TAX,
			SUM(D.TOTAL_INCOME_TAX) S_TOTAL_INCOME_TAX,
			SUM(D.TOTAL_NHI_AMT) S_TOTAL_NHI_AMT,
			SUM(D.TAX_EXCLUSIVE_TOTAL_AMT+D.TOTAL_BUSINESS_TAX-D.TOTAL_INCOME_TAX-D.TOTAL_NHI_AMT) AMOUNT_DUE,
			A.CASH_REQ_NO,
			A.APP_USER,
			A.APP_DATE, 
			A.ACCOUNT_APPROVAL_USER,
			A.ACCOUNT_APPROVAL_DATE,
			(SELECT CHN_NM FROM TB_AUTH_PERSONNEL WHERE PSN_NO=A.APP_USER) APP_USER_DSCR,
		    (SELECT CHN_NM FROM TB_AUTH_PERSONNEL WHERE PSN_NO=A.ACCOUNT_APPROVAL_USER) ACCOUNT_APPROVAL_USER_DSCR,
		    A.DOMAIN,
		    A.PROCESS_TYPE,
		    A.STATUS,
		    A.YEAR_MONTH,
		    (select lookup_code_desc from TB_PAY_LOOKUP_CODE where lookup_type='cash_req_status' and lookup_code=A.STATUS) statusDscr,
		     SUM (C.tax_exclusive_amt+C.business_tax) S_EXCLUSIVE_BUSINESS_TAX
	  FROM  TB_PAY_CASH_REQUIREMENT A,
			TB_PAY_PAYMENT_REQUEST B,
			TB_PAY_PAYMENT_REQUEST_DTL C,
			TB_PAY_PAYMENT D, 
			TB_PAY_VOUCHER_CREDIT E, 
			TB_PAY_PAYMENT_REQUEST_VOUCHER F
	 WHERE  A.CASH_REQ_NO=B.CASH_REQ_NO 
			AND B.PAYMENT_REQ_NO=C.PAYMENT_REQ_NO 
			AND C.PAYMENT_REQ_NO=D.PAYMENT_REQ_NO 
			AND C.ITEM_NO=D.PAYMENT_REQ_ITEM_NO 
			AND E.PAYMENT_REQ_NO=C.PAYMENT_REQ_NO 
			AND E.PAYMENT_REQ_ITEM_NO=C.ITEM_NO 
			AND E.MST_SEQ_NBR=F.SEQ_NBR 
			AND A.CASH_REQ_NO LIKE 'E%'
			<if test="domain!=null and domain!=''">
			AND A.DOMAIN = #{domain}
			</if>
			<if test="processType!=null and processType!=''">
			AND A.PROCESS_TYPE = #{processType}
			</if>
			<if test="paymentPeriod!=null and paymentPeriod!=''">
			AND A.PAYMENT_PERIOD = #{paymentPeriod}
			</if>
			<if test="appStartDate !=null and appStartDate !='' and appEndDate != null and appEndDate !=''">
			AND A.APP_DATE BETWEEN #{appStartDate} AND #{appEndDate}
			</if>
			<if test="cashReqNo!=null and cashReqNo!=''">
			AND A.CASH_REQ_NO LIKE '%'+#{cashReqNo}+'%'
			</if>	
			<if test="status!=null and status!=''">
	     	AND A.STATUS IN	
		     <foreach collection="status" item="item" open="(" close=")" separator=",">
		      #{item}
		      </foreach>
	     	</if>
	     	Group by A.CASH_REQ_NO,A.app_user,A.app_date, A.account_approval_user,A.account_approval_date,A.DOMAIN,
		    A.PROCESS_TYPE,A.STATUS,A.YEAR_MONTH
			
	</select>
	


	<update id="updateByPAY003" parameterType="map">
	 Update TB_PAY_CASH_REQUIREMENT set
		status= 'B',
		md_user=#{appUser},
		md_time=getDate()
		Where cash_req_no=#{cashReqNo}
	</update>
	<!--************************************************************************************************************-->
	<!--************************************************************************************************************-->
	<!--************************************************************************************************************-->
	
    <resultMap id="payCashResultMap" type="com.foya.noms.dto.pay.TbPayCashRequirementCompleteDTO">
    	<result column="payBillsDataSize" property="payBillsDataSize" />
	    <result column="voucherSize" property="voucherSize" />
	    <result column="payDataTotalAmtSum" property="payDataTotalAmtSum" />
	    <result column="payDataBusinessTaxSum" property="payDataBusinessTaxSum" />
	    <result column="payDataIncomeTaxSum" property="payDataIncomeTaxSum" />
	    <result column="payDataNhiAmtSUm" property="payDataNhiAmtSUm" />
	    <result column="payable" property="payable" />
	    <result column="payBillsUserName" property="payBillsUserName" />
	    <result column="payBillsCheckUserName" property="payBillsCheckUserName" />
    </resultMap>
    
    <sql id="payCashRequirementColumns">
		TB_PAY_CASH_REQUIREMENT.CASH_REQ_NO,
		TB_PAY_CASH_REQUIREMENT.SUBPOENA_DATE,
		TB_PAY_CASH_REQUIREMENT.SUBPOENA_NBR,
		TB_PAY_CASH_REQUIREMENT.ACCOUNT_APPROVAL_DATE,
		TB_PAY_CASH_REQUIREMENT.ACCOUNT_APPROVAL_USER,
		TB_PAY_CASH_REQUIREMENT.REJECT_REASON,
		TB_PAY_CASH_REQUIREMENT.REJECT_MEMO,
		TB_PAY_CASH_REQUIREMENT.DOMAIN,
		TB_PAY_CASH_REQUIREMENT.PROCESS_TYPE,
		TB_PAY_CASH_REQUIREMENT.PAYMENT_PERIOD,
		TB_PAY_CASH_REQUIREMENT.APP_USER,
		TB_PAY_CASH_REQUIREMENT.APP_DATE,
		TB_PAY_CASH_REQUIREMENT.YEAR_MONTH,
		TB_PAY_CASH_REQUIREMENT.STATUS,
		TB_PAY_CASH_REQUIREMENT.TO_ERP_DATE,
		TB_PAY_CASH_REQUIREMENT.CR_USER,
		TB_PAY_CASH_REQUIREMENT.CR_TIME,
		TB_PAY_CASH_REQUIREMENT.MD_USER,
		TB_PAY_CASH_REQUIREMENT.MD_TIME
	</sql>
	
	<!-- 取得請款單號 -->
	<select id="getPayRequirementNo" resultType="com.foya.dao.mybatis.model.TbPayCashRequirement" parameterType="String">
		Select
			<include refid="payCashRequirementColumns"/>
		From TB_PAY_CASH_REQUIREMENT
		Where
			CASH_REQ_NO Like #{payType}+'%'
		<if test="maintainArea != null">
		And DOMAIN = #{maintainArea}
		</if>
	</select>
	
	<!-- 取得專線請款資料 -->
	<select id="getPayCashData" resultMap="payCashResultMap" parameterType="String">
		select 
			payBills.CASH_REQ_NO,
			COUNT(payBillsData.CASH_REQ_NO) as payBillsDataSize,
			COUNT(voucher.SEQ_NBR) as voucherSize,
			SUM(payData.TAX_EXCLUSIVE_TOTAL_AMT) as payDataTotalAmtSum,
			SUM(payData.TOTAL_BUSINESS_TAX) as payDataBusinessTaxSum,
			SUM(payData.TOTAL_INCOME_TAX) as payDataIncomeTaxSum,
			SUM(payData.TOTAL_NHI_AMT) as payDataNhiAmtSUm,
			SUM((payData.TAX_EXCLUSIVE_TOTAL_AMT+payData.TOTAL_BUSINESS_TAX)- (payData.TOTAL_INCOME_TAX+payData.TOTAL_NHI_AMT)) as payable,
			(select pesonnel.CHN_NM from TB_AUTH_PERSONNEL pesonnel where PSN_NO = payBills.APP_USER) as payBillsUserName,
			payBills.APP_DATE,
			(select pesonnel.CHN_NM from TB_AUTH_PERSONNEL pesonnel where PSN_NO = payBills.ACCOUNT_APPROVAL_USER) as payBillsCheckUserName,
			payBills.ACCOUNT_APPROVAL_DATE
		From 
			TB_PAY_CASH_REQUIREMENT payBills
		JOIN
			TB_PAY_PAYMENT_REQUEST payBillsData
		ON	payBills.CASH_REQ_NO = payBillsData.CASH_REQ_NO
		JOIN
			TB_PAY_PAYMENT_REQUEST_DTL payBillsDataDtl
		ON	payBillsDataDtl.PAYMENT_REQ_NO = payBillsData.PAYMENT_REQ_NO
		JOIN
			TB_PAY_PAYMENT payData
		ON	payBillsDataDtl.payment_req_no = payData.payment_req_no
		And	payBillsDataDtl.ITEM_NO = payData.PAYMENT_REQ_ITEM_NO
		JOIN
			TB_PAY_VOUCHER_CREDIT credit
		ON	payBillsDataDtl.payment_req_no = credit.payment_req_no
		And	payBillsDataDtl.ITEM_NO = credit.PAYMENT_REQ_ITEM_NO
		JOIN
			TB_PAY_PAYMENT_REQUEST_VOUCHER voucher
		ON	
			credit.MST_SEQ_NBR = voucher.SEQ_NBR
		<!-- Where -->
		
		
		Group by payBills.CASH_REQ_NO,payBillsData.CASH_REQ_NO,payBills.APP_USER,payBills.ACCOUNT_APPROVAL_USER,payBills.APP_DATE,
		payData.TAX_EXCLUSIVE_TOTAL_AMT,payBills.ACCOUNT_APPROVAL_DATE
	</select>

	<!--************************************************************************************************************-->
	<!--************************************************************************************************************-->
	<!--************************************************************************************************************-->
	
	<select id="selectTbPayCashRequirementPay001" resultType="com.foya.noms.dto.pay.TbPayCashRequirementDTO" parameterType="hashmap">
	SELECT COUNT (B.payment_req_no) reqCnt,
	       SUM (B.voucherCnt) voucherCnt,	       
	       SUM (sumTaxExclusiveTotalAmt) sumTaxExclusiveTotalAmt,
	       SUM (sumTotalBusinessTax) sumTotalBusinessTax,
	       SUM (sumTotalIncomeTax) sumTotalIncomeTax,
	       SUM (sumTotalNhiAmt) sumTotalNhiAmt,
	       SUM (amountDue) AMOUNT_DUE,
	       A.cash_req_no,
	       (select chn_nm from TB_AUTH_PERSONNEL where psn_no=A.app_user)appUserCnm,
	       A.app_date,
	       (select chn_nm from TB_AUTH_PERSONNEL where psn_no=A.account_approval_user)accountApprovalUserCnm,
	       A.account_approval_date,
	       A.reject_reason,
	       (select lookup_code_desc from TB_PAY_LOOKUP_CODE where lookup_type='CASH_REQ_STATUS' and lookup_code=A.status) statusDscr,
	       A.status	,
	       A.process_type,
	       isnull( (Select SUM (BB.tax_exclusive_amt + BB.business_tax) 
		       from TB_PAY_PAYMENT_REQUEST AA,TB_PAY_PAYMENT_REQUEST_DTL BB
		       where AA.payment_req_no=BB.payment_req_no and AA.cash_req_no=A.cash_req_no and BB.payment_request_item='REP04'
		       ),0)sumPenalty
	FROM TB_PAY_CASH_REQUIREMENT A,
		(SELECT B.payment_req_no, B.cash_req_no,
		       (Select COUNT(distinct mst_seq_nbr) From TB_PAY_VOUCHER_CREDIT E Where B.payment_req_no = E.payment_req_no) voucherCnt,
		       SUM (D.tax_exclusive_total_amt) sumTaxExclusiveTotalAmt,
		       SUM (D.total_business_tax) sumTotalBusinessTax,
		       SUM (D.total_income_tax) sumTotalIncomeTax,
		       SUM (D.total_NHI_amt) sumTotalNhiAmt,
		       SUM (
		            D.tax_exclusive_total_amt
		          + D.total_business_tax
		          - D.total_income_tax
		          - D.total_NHI_amt)
		          amountDue
		  FROM TB_PAY_PAYMENT_REQUEST B, TB_PAY_PAYMENT_REQUEST_DTL C,
		       TB_PAY_PAYMENT D
		 WHERE B.payment_req_no=C.payment_req_no and
				C.payment_req_no=D.payment_req_no and
				C.item_no=D.payment_req_item_no 
		 And Exists (Select 1 From TB_PAY_CASH_REQUIREMENT A
			 	 WHERE  A.cash_req_no = B.cash_req_no
			 	AND a.cash_req_no like 'R%'
		       	<if test="domain!=null and domain!=''">
				AND A.domain = #{domain}
				</if>
				<if test="processType !=null and processType !=''">
				AND A.process_type = #{processType}
				</if>
				<if test="paymentPeriod !=null and paymentPeriod !=''">
				AND A.payment_period = #{paymentPeriod}
				</if>
				<if test="appDateStart !=null and appDateStart !='' and appDateEnd !=null and appDateEnd !='' ">
				and A.app_date between convert(date,#{appDateStart}) and convert(date,#{appDateEnd})
				</if>
				<if test="cashReqNo != null and cashReqNo !=''">
					AND a.cash_req_no like '%'+#{cashReqNo}+'%'
				</if>
				<if test="status!=null and status!=''">
					and A.status in
					<foreach collection="status" item="item" open="("
						separator="," close=")">
						#{item}
					</foreach>
				</if>
		 )
		 Group by B.payment_req_no, B.cash_req_no) B
	 WHERE  A.cash_req_no = B.cash_req_no
	Group by A.cash_req_no,A.app_user,A.app_date,
	A.account_approval_user,A.account_approval_date,A.reject_reason, A.status, A.process_type	
	</select>
	
	<select id="selectTbPayCashRequirementPay013" resultType="com.foya.noms.dto.pay.TbPayCashRequirementDTO" parameterType="hashmap">
		SELECT B.CONTRACT_NO,
		       D.LOCATION_ID,
		       C.TAX_EXCLUSIVE_AMT,
		       C.BUSINESS_TAX,
		       C.PAYMENT_REQ_NO,
		       C.ITEM_NO,
		       D.SEQ_NBR
		  FROM TB_PAY_CASH_REQUIREMENT A,
		       TB_PAY_PAYMENT_REQUEST B,
		       TB_PAY_PAYMENT_REQUEST_DTL C,
		       TB_PAY_PAYMENT D
		 WHERE A.CASH_REQ_NO = B.CASH_REQ_NO
		   AND B.PAYMENT_REQ_NO = C.PAYMENT_REQ_NO
		   AND C.PAYMENT_REQ_NO = D.PAYMENT_REQ_NO
		   AND C.ITEM_NO = D.PAYMENT_REQ_ITEM_NO
		   AND C.LOCATION_ID = D.LOCATION_ID
		   AND A.STATUS = 'G'
		  <if test="yearMonth!=null and yearMonth!=''">
				AND A.YEAR_MONTH = #{yearMonth}
		   </if>
		 
		   AND (A.cash_req_no like ('E%') OR A.cash_req_no like ('R%'))
	</select>
	
	<!--<select id="selectTbPayCashRequirementPay013" resultType="com.foya.noms.dto.pay.TbPayCashRequirementDTO" parameterType="hashmap">
		SELECT B.CONTRACT_NO,
		       D.LOCATION_ID,
		       C.TAX_EXCLUSIVE_AMT,
		       C.BUSINESS_TAX,
		       C.PAYMENT_REQ_NO,
		       C.ITEM_NO,
		       D.SEQ_NBR
		  FROM TB_PAY_CASH_REQUIREMENT A,
		       TB_PAY_PAYMENT_REQUEST B,
		       TB_PAY_PAYMENT_REQUEST_DTL C,
		       TB_PAY_PAYMENT D
		 WHERE A.CASH_REQ_NO = B.CASH_REQ_NO
		   AND B.PAYMENT_REQ_NO = C.PAYMENT_REQ_NO
		   AND C.PAYMENT_REQ_NO = D.PAYMENT_REQ_NO
		   AND C.ITEM_NO = D.PAYMENT_REQ_ITEM_NO
		   AND C.LOCATION_ID = D.LOCATION_ID
		   AND A.STATUS = 'G'
		  <if test="yearMonth!=null and yearMonth!=''">
				AND A.YEAR_MONTH = #{yearMonth}
		   </if>
		 
		   AND (A.cash_req_no like ('E%') OR A.cash_req_no like ('R%'))
	</select>-->

</mapper>